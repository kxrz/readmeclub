---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';
import Seo from '@/components/fundations/head/Seo.astro';
import { supabase } from '@/lib/supabase/client';
import { countries } from '@/lib/utils/countries';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch location stats
const { data: locationStats } = await supabase
  .from('location_declarations')
  .select('country_code')
  .order('created_at', { ascending: false });

// Aggregate by country_code
const stats: Record<string, number> = {};
let total = 0;
if (locationStats) {
  for (const declaration of locationStats) {
    const code = declaration.country_code.toUpperCase();
    stats[code] = (stats[code] || 0) + 1;
    total++;
  }
}

// Get coordinates for countries with data
const markers = Object.entries(stats).map(([code, count]) => ({
  code,
  count,
  name: countries[code]?.name || code,
  coords: countries[code]?.coords || null,
})).filter(m => m.coords !== null);
---

<BaseLayout>
  <Seo
    title={t('location.title')}
    description={t('location.subtitle')}
    canonical={`${Astro.site}/location`}
    lang={lang}
  />

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('location.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('location.subtitle')}
      </Text>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <div class="space-y-6">
        <!-- Stats Summary -->
        <div class="bg-base-50 rounded-lg p-6 border border-base-200">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <Text tag="h2" variant="textXL" class="font-semibold text-base-900 mb-2">
                {`${total} ${total === 1 ? 'user' : 'users'}`}
              </Text>
              <Text tag="p" variant="textBase" class="text-base-600">
                {`${Object.keys(stats).length} ${Object.keys(stats).length === 1 ? 'country' : 'countries'}`}
              </Text>
            </div>
            
            <!-- Declare Location Form -->
            <div class="flex items-center gap-4">
              <select
                id="countrySelect"
                class="px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400 min-w-[200px]"
              >
                <option value="">{t('location.select_country')}</option>
                {Object.entries(countries).sort((a, b) => a[1].name.localeCompare(b[1].name)).map(([code, country]) => (
                  <option value={code}>{country.name} ({code})</option>
                ))}
              </select>
              <button
                id="declareBtn"
                class="px-6 py-2 bg-accent-500 text-white hover:bg-accent-600 rounded-lg transition-colors"
              >
                {t('location.submit')}
              </button>
            </div>
          </div>
        </div>

        <!-- Map Container -->
        <div id="map" class="w-full h-[600px] rounded-lg border-2 border-base-200"></div>
        
        {markers.length === 0 ? (
          <div class="text-center py-12">
            <Text tag="p" variant="textBase" class="text-base-500">
              {t('location.no_data')}
            </Text>
          </div>
        ) : (
          <!-- Statistics Table -->
          <div class="bg-base-50 rounded-lg border border-base-200 overflow-hidden">
            <div class="p-6 border-b border-base-200">
              <Text tag="h2" variant="textXL" class="font-semibold text-base-900">
                {t('location.stats_table')}
              </Text>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-base-100">
                  <tr>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-base-900 border-b border-base-200">
                      {t('location.country')}
                    </th>
                    <th class="px-6 py-3 text-right text-sm font-semibold text-base-900 border-b border-base-200">
                      {t('location.users')}
                    </th>
                    <th class="px-6 py-3 text-right text-sm font-semibold text-base-900 border-b border-base-200 w-32">
                      {t('location.percentage')}
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-base-200">
                  {Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([code, count]) => {
                      const country = countries[code];
                      const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                      return (
                        <tr class="hover:bg-base-50 transition-colors">
                          <td class="px-6 py-4 text-sm text-base-900">
                            <div class="flex items-center gap-3">
                              <span class="font-medium text-base-700">{code}</span>
                              {country && (
                                <span class="text-base-600">{country.name}</span>
                              )}
                            </div>
                          </td>
                          <td class="px-6 py-4 text-sm text-base-900 text-right font-medium">
                            {count}
                          </td>
                          <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                              <div class="flex-1 max-w-[100px] h-2 bg-base-200 rounded-full overflow-hidden">
                                <div 
                                  class="h-full rounded-full transition-all"
                                  style={`width: ${percentage}%; background: linear-gradient(90deg, #283618 0%, #606c38 50%, #dda15e 100%);`}
                                ></div>
                              </div>
                              <span class="text-sm text-base-600 w-12 text-right">{percentage}%</span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </Wrapper>
  </section>
</BaseLayout>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
  // Wait for DOM and Leaflet to be ready
  document.addEventListener('DOMContentLoaded', () => {
    // Load Leaflet dynamically
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = () => {
      // Initialize map with bounds to prevent zooming out too far
      const map = L.map('map', {
        minZoom: 2,
        maxBounds: [
          [-90, -180], // Southwest corner
          [90, 180]    // Northeast corner
        ],
        maxBoundsViscosity: 1.0 // Prevent dragging outside bounds
      }).setView([20, 0], 2);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 2,
      }).addTo(map);
      
      // Markers data from server
      const markersData = JSON.parse(document.getElementById('markers-data')?.textContent || '[]');
      
      // Calculate max count for scaling
      const maxCount = Math.max(...markersData.map((m: any) => m.count), 1);
      
      // Function to calculate circle radius based on count
      const getRadius = (count: number) => {
        // Minimum radius: 8px, Maximum radius: 50px
        // Scale logarithmically for better visual distribution
        const minRadius = 8;
        const maxRadius = 50;
        const ratio = Math.log(count + 1) / Math.log(maxCount + 1);
        return minRadius + (maxRadius - minRadius) * ratio;
      };
      
      // Function to get color based on count
      const getColor = (count: number) => {
        const ratio = count / maxCount;
        if (ratio > 0.7) return '#bc6c25'; // copperwood (high)
        if (ratio > 0.4) return '#dda15e'; // sunlit-clay (medium-high)
        if (ratio > 0.2) return '#606c38'; // olive-leaf (medium)
        return '#283618'; // black-forest (low)
      };
      
      // Add circle markers for each country
      markersData.forEach(({ code, count, name, coords }: any) => {
        if (coords && coords.length === 2) {
          const [lat, lng] = coords;
          const radius = getRadius(count);
          const color = getColor(count);
          
          const circle = L.circleMarker([lat, lng], {
            radius: radius,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.7,
          }).addTo(map);
          
          circle.bindPopup(`
            <div class="p-2">
              <strong>${name}</strong> (${code})<br>
              ${count} ${count === 1 ? 'user' : 'users'}
            </div>
          `);
          
          // Add hover effect
          circle.on('mouseover', function() {
            this.setStyle({
              fillOpacity: 0.9,
              weight: 3,
            });
          });
          
          circle.on('mouseout', function() {
            this.setStyle({
              fillOpacity: 0.7,
              weight: 2,
            });
          });
        }
      });
      
      // Declare location handler
      document.getElementById('declareBtn')?.addEventListener('click', async () => {
        const select = document.getElementById('countrySelect') as HTMLSelectElement;
        const countryCode = select.value;
        
        if (!countryCode) {
          alert('Please select a country');
          return;
        }
        
        try {
          const res = await fetch('/api/location/declare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country_code: countryCode }),
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            throw new Error(data.error || 'Failed to declare location');
          }
          
          alert('Location declared successfully!');
          window.location.reload();
        } catch (error: any) {
          alert(`Error: ${error.message}`);
        }
      });
    };
    document.head.appendChild(script);
  });
</script>
<script id="markers-data" type="application/json" set:html={JSON.stringify(markers)}></script>
