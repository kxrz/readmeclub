---
export const prerender = true; // Page statique avec pagination via query params

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Fragment } from "astro/jsx-runtime";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import ResourceCard from "@/components/resources/ResourceCard.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import Link from "@/components/fundations/components/Link.astro";
import { loadAllResources, filterAndSortResources, paginateResources } from '@/lib/utils/resource-loader';
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = Astro.site || 'https://readme.club';

// Pagination
const url = Astro.url;
const type = url.searchParams.get('type') || null;
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 50;

// Charger toutes les resources depuis JSON statique
const allResources = await loadAllResources();

// Filtrer et trier
const filteredResources = filterAndSortResources(allResources, {
  type: type || undefined,
  sortBy: 'created_at',
  sortOrder: 'desc',
});

// Paginer
const pagination = paginateResources(filteredResources, page, limit);
const resources = pagination.data;
const totalPages = pagination.totalPages;

// Générer les pages de pagination
function generatePaginationPages(current: number, total: number): (number | string)[] {
  const pages: (number | string)[] = [];
  
  if (total <= 7) {
    // Afficher toutes les pages si <= 7
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    // Logique de pagination avec ellipses
    if (current <= 3) {
      for (let i = 1; i <= 4; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    } else if (current >= total - 2) {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = total - 3; i <= total; i++) pages.push(i);
    } else {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = current - 1; i <= current + 1; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    }
  }
  
  return pages;
}

const paginationPages = totalPages > 1 ? generatePaginationPages(pagination.currentPage, totalPages) : [];

const resourceTypes = [
  { value: 'tool', label: t('resources.type.tool') },
  { value: 'language_file', label: t('resources.type.language_file') },
  { value: 'plugin', label: t('resources.type.plugin') },
  { value: 'documentation', label: t('resources.type.documentation') },
  { value: 'link', label: t('resources.type.link') },
  { value: 'other', label: t('resources.type.other') },
];
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('resources.title')} - ${t('site.name')}`}
      description={t('resources.subtitle')}
      canonical={`${siteUrl}${langPrefix}/resources`}
      lang={lang}
    />
  </Fragment>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('resources.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('resources.subtitle')}
      </Text>
      <div class="mt-4">
        <a
          href={`${langPrefix}/submit`}
          class="inline-flex items-center gap-1.5 text-sm text-base-500 hover:text-accent-500 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('resources.add_new')}
        </a>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6">
      <div
        class="scrollable-content relative flex snap-x snap-proximity gap-2 py-2 px-2 overflow-x-scroll scrollbar-hide"
      >
        <Link
          size="xs"
          variant="ghost"
          title={t('common.filter') + ': All'}
          aria-label={t('common.filter') + ': All'}
          href={`${lang === 'en' ? '' : `/${lang}`}/resources`}
          class={!type ? 'bg-base-900 text-white hover:bg-base-800 ring-base-900 font-semibold' : 'text-base-900 bg-white ring-2 ring-base-400 hover:ring-accent-400 hover:bg-accent-50 font-medium'}
        >
          {t('common.filter')}: All
        </Link>
        {resourceTypes.map((rt) => (
          <Link
            size="xs"
            variant="ghost"
            title={rt.label}
            aria-label={rt.label}
            href={`${lang === 'en' ? '' : `/${lang}`}/resources?type=${rt.value}`}
            class={type === rt.value ? 'bg-base-900 text-white hover:bg-base-800 ring-base-900 font-semibold' : 'text-base-900 bg-white ring-2 ring-base-400 hover:ring-accent-400 hover:bg-accent-50 font-medium'}
          >
            {rt.label}
          </Link>
        ))}
      </div>
      
      <!-- Resources Grid -->
      {resources && resources.length > 0 ? (
        <Fragment>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3 mt-2">
            {resources.map((resource) => (
              <ResourceCard resource={resource} />
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 mt-12">
              {pagination.currentPage > 1 && (
                <a
                  href={`${langPrefix}/resources${type ? `?type=${type}${pagination.currentPage > 2 ? `&page=${pagination.currentPage - 1}` : ''}` : pagination.currentPage > 2 ? `?page=${pagination.currentPage - 1}` : ''}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.previous')}
                </a>
              )}
              
              <div class="flex items-center gap-1">
                {paginationPages.map((p) => {
                  if (p === 'ellipsis') {
                    return <span class="px-2 text-base-500">...</span>;
                  }
                  const pageNum = p as number;
                  const pageUrl = `${langPrefix}/resources${type ? `?type=${type}${pageNum > 1 ? `&page=${pageNum}` : ''}` : pageNum > 1 ? `?page=${pageNum}` : ''}`;
                  return (
                    <a
                      href={pageUrl}
                      class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                        pageNum === pagination.currentPage
                          ? 'bg-base-900 text-white'
                          : 'text-base-700 bg-white border border-base-200 hover:border-accent-300 hover:text-accent-500'
                      }`}
                    >
                      {pageNum}
                    </a>
                  );
                })}
              </div>

              {pagination.currentPage < totalPages && (
                <a
                  href={`${langPrefix}/resources${type ? `?type=${type}&page=${pagination.currentPage + 1}` : `?page=${pagination.currentPage + 1}`}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.next')}
                </a>
              )}
            </div>
          )}
        </Fragment>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('resources.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

