---
// Pré-rendu statique pour réduire drastiquement les requêtes DB
export const prerender = true;

// Génère toutes les langues au build
export async function getStaticPaths() {
  const langs = ['en', 'fr', 'es', 'ru', 'cn'];
  return langs.map((lang) => ({
    params: { lang },
  }));
}

import BaseLayout from "@/layouts/BaseLayout.astro";
import Hero from "@/components/landing/Hero.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import ResourceCard from "@/components/resources/ResourceCard.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import SmallResourceCard from "@/components/resources/SmallResourceCard.astro";
import SmallMoreCard from "@/components/resources/SmallMoreCard.astro";
import LatestResourceCard from "@/components/resources/LatestResourceCard.astro";
import LatestMoreCard from "@/components/resources/LatestMoreCard.astro";
import GuideCard from "@/components/resources/GuideCard.astro";
import MoreCard from "@/components/common/MoreCard.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import { useTranslations } from '@/i18n/utils';
import type { Lang } from '@/i18n/utils';
import { loadAllWallpapers } from '@/lib/utils/wallpaper-loader';
import { loadAllResources, filterAndSortResources } from '@/lib/utils/resource-loader';

const lang = (Astro.params.lang || 'en') as Lang;
const t = useTranslations(lang);
const siteUrl = Astro.site || 'https://readme.club';

// Charger les resources depuis JSON statique
const allResources = await loadAllResources();

// Latest resources pour activity feed
const latestResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
}).slice(0, 5);

// Featured resources (most downloaded)
const featuredResources = filterAndSortResources(allResources, {
  sortBy: 'downloads_count',
  sortOrder: 'desc',
})
  .filter(r => (r.downloads_count || 0) > 0)
  .slice(0, 8);

// Starred resources
const starredResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
})
  .filter(r => r.starred === true)
  .slice(0, 6);

// Charger les wallpapers depuis les fichiers statiques
const allWallpapers = await loadAllWallpapers();
const latestWallpapers = allWallpapers
  .filter(w => !w.hidden)
  .sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
    return dateB - dateA;
  })
  .slice(0, 4);

// News retirées - maintenant affichées uniquement sur /news
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('site.name')} - ${t('site.tagline')}`}
      description={t('site.description')}
      canonical={`${siteUrl}${langPrefix || '/'}`}
      lang={lang}
    />
  </Fragment>
  <Hero />
  
  {/* Section Guide & Tips */}
  <section>
    <Wrapper variant="standard" class="pt-6 pb-12">
      <div class="pt-2">
        <div class="bg-gradient-to-br from-accent-50 to-base-50 rounded-xl border border-accent-200 p-6 md:p-8">
          <Text
            tag="h2"
            variant="textLG"
            class="font-semibold text-base-900 mb-3"
          >
            {t('homepage.new_user.title')}
          </Text>
          <Text
            tag="p"
            variant="textBase"
            class="text-base-700 mb-6 leading-relaxed"
          >
            {t('homepage.new_user.description')}
          </Text>
          <div class="flex flex-wrap gap-3">
            <a
              href={`/${lang}/guide`}
              class="inline-flex items-center gap-2 px-4 py-2 bg-accent-500 text-white rounded-lg hover:bg-accent-600 transition-colors font-medium text-sm"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                <path d="M9 9l1 0"></path>
                <path d="M9 13l6 0"></path>
                <path d="M9 17l6 0"></path>
              </svg>
              {t('guide.title')}
            </a>
            <a
              href={`/${lang}/tips`}
              class="inline-flex items-center gap-2 px-4 py-2 bg-white text-base-700 border border-base-300 rounded-lg hover:border-accent-400 hover:text-accent-600 transition-colors font-medium text-sm"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 2l3.09 6.26l6.91 1.01l-5 4.87l1.18 6.88l-6.18 -3.25l-6.18 3.25l1.18 -6.88l-5 -4.87l6.91 -1.01z"></path>
              </svg>
              {t('tips.title')}
            </a>
          </div>
        </div>
      </div>
    </Wrapper>
  </section>
  
  {latestResources && latestResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-12">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.latest_additions')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`/${lang}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {latestResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`/${lang}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}
  
  {featuredResources && featuredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.most_downloaded')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`/${lang}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {featuredResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`/${lang}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}


  {starredResources && starredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.starred_resources')}
          </Text>
        </div>
        <div class="grid grid-cols-1 gap-2 mt-6">
          {starredResources.map((resource) => (
            <SmallResourceCard resource={resource} />
          ))}
          <SmallMoreCard href={`/${lang}/resources`} label={t('common.view') + ' all'} />
        </div>
      </Wrapper>
    </section>
  )}

  {latestWallpapers && latestWallpapers.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('wallpapers.title')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`/${lang}/wallpapers`}
            aria-label={t('nav.wallpapers')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="grid grid-cols-3 gap-3 md:grid-cols-4 xl:grid-cols-6 mt-8">
          {latestWallpapers.map((wallpaper) => (
            <WallpaperCard wallpaper={wallpaper} />
          ))}
          <MoreCard href={`/${lang}/wallpapers`} label={t('common.view') + ' all'} variant="wallpaper" />
        </div>
      </Wrapper>
    </section>
  )}

  
  <section>
    <Wrapper variant="standard" class="pt-6 pb-24">
      <div class="border-t border-base-200 pt-2">
        <Text
          tag="h2"
          variant="textXS"
          class="font-medium uppercase text-base-600"
        >
          {t('disclaimer.title')}
        </Text>
        <Text
          tag="p"
          variant="textSM"
          class="mt-4 text-base-600"
        >
          {t('disclaimer.content')}
        </Text>
      </div>
    </Wrapper>
  </section>
</BaseLayout>

