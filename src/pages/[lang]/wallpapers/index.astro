---
// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import { supabase } from '@/lib/supabase/client';
import { cachedQuery, cachedCount, CacheKeys } from '@/lib/supabase/cache';
import { useTranslations } from '@/i18n/utils';
import type { Lang } from '@/i18n/utils';

const lang = (Astro.params.lang || 'en') as Lang;
const t = useTranslations(lang);

const url = Astro.url;
const category = url.searchParams.get('category') || null;
const sort = url.searchParams.get('sort') || 'latest';
const pageParam = url.searchParams.get('page');
const page = Math.max(1, parseInt(pageParam || '1', 10));
const pageSize = 24;
const from = (page - 1) * pageSize;
const to = from + pageSize;

// Query avec cache (TTL long car invalidation manuelle)
const { data: rawWallpapers } = await cachedQuery(
  () => {
    let query = supabase
      .from('wallpapers')
      .select('*')
      .eq('status', 'published')
      .eq('hidden', false);

    if (category) {
      query = query.eq('category', category);
    }

    if (sort === 'popular') {
      query = query.order('download_count', { ascending: false });
    } else if (sort === 'name') {
      query = query.order('title', { ascending: true, nullsFirst: false });
    } else if (sort === 'author') {
      query = query.order('author_name', { ascending: true, nullsFirst: false });
    } else {
      query = query.order('created_at', { ascending: false });
    }

    return query.range(from, to);
  },
  {
    key: await CacheKeys.wallpapersPage(page, category || undefined, sort),
    ttl: 86400,
    lang,
    contentType: 'wallpapers',
    parts: [page, category, sort],
  }
);

const wallpapers = rawWallpapers ? rawWallpapers.slice(0, pageSize) : [];
const hasNext = !!rawWallpapers && rawWallpapers.length > pageSize;
const hasPrev = page > 1;

// Count query avec cache (TTL long car invalidation manuelle)
const { data: wallpapersCount } = await cachedCount(
  () => supabase
    .from('wallpapers')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'published')
    .eq('hidden', false),
  {
    key: await CacheKeys.wallpapersCount(),
    ttl: 86400,
    contentType: 'wallpapers',
  }
);

const totalWallpapers = wallpapersCount || 0;
const baseSubtitle = t('wallpapers.subtitle');
const normalizedSubtitle = baseSubtitle.length > 0 ? baseSubtitle[0].toLowerCase() + baseSubtitle.slice(1) : baseSubtitle;
const wallpapersSubtitle = totalWallpapers > 0 ? `${totalWallpapers} ${normalizedSubtitle}` : baseSubtitle;

const categories = [
  { value: 'minimalist', label: t('wallpapers.category.minimalist') },
  { value: 'dark', label: t('wallpapers.category.dark') },
  { value: 'light', label: t('wallpapers.category.light') },
  { value: 'pop_culture', label: t('wallpapers.category.pop_culture') },
  { value: 'custom', label: t('wallpapers.category.custom') },
  { value: 'other', label: t('wallpapers.category.other') },
];

const sortOptions = [
  { value: 'latest', label: t('common.sort.latest') },
  { value: 'popular', label: t('common.sort.popular') },
  { value: 'name', label: t('common.sort.name') },
  { value: 'author', label: t('common.sort.author') },
];
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('wallpapers.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {wallpapersSubtitle}
      </Text>
      <div class="mt-4">
        <a
          href={`/${lang}/submit-wallpaper`}
          class="inline-flex items-center gap-1.5 text-sm text-base-500 hover:text-accent-500 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('wallpapers.add_new')}
        </a>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6">
      <div class="flex flex-col gap-4 mb-6 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.filter')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            {categories.map((cat) => {
              const params = new URLSearchParams();
              if (sort !== 'latest') params.set('sort', sort);
              params.set('category', cat.value);
              const categoryUrl = params.toString() ? `/${lang}/wallpapers?${params.toString()}` : `/${lang}/wallpapers?category=${cat.value}`;
              return (
                <a
                  href={categoryUrl}
                  class={`px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                    category === cat.value
                      ? 'bg-accent-500 text-white'
                      : 'bg-base-100 text-base-700 hover:bg-base-200'
                  }`}
                >
                  {cat.label}
                </a>
              );
            })}
            {category && (
              <a
                href={`/${lang}/wallpapers${sort !== 'latest' ? `?sort=${sort}` : ''}`}
                class="px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset filter"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.sort')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            {sortOptions.map((option) => {
              const params = new URLSearchParams();
              if (category) params.set('category', category);
              if (option.value !== 'latest') params.set('sort', option.value);
              const sortUrl = params.toString() ? `/${lang}/wallpapers?${params.toString()}` : `/${lang}/wallpapers`;
              return (
                <a
                  href={sortUrl}
                  class={`px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                    sort === option.value
                      ? 'bg-accent-500 text-white'
                      : 'bg-base-100 text-base-700 hover:bg-base-200'
                  }`}
                >
                  {option.label}
                </a>
              );
            })}
            {sort !== 'latest' && (
              <a
                href={`/${lang}/wallpapers${category ? `?category=${category}` : ''}`}
                class="px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset sort"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
      
      {wallpapers && wallpapers.length > 0 ? (
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
            {wallpapers.map((wallpaper) => (
              <WallpaperCard wallpaper={wallpaper} />
            ))}
          </div>

          {(hasPrev || hasNext) && (
            <div class="flex items-center justify-center gap-3 md:gap-4 pt-6 md:pt-10 mt-6 md:mt-10 pb-2 md:pb-4 border-t border-base-200">
              {hasPrev ? (
                <a
                  href={`/${lang}/wallpapers${category ? `?category=${category}` : ''}${category && sort !== 'latest' ? '&' : sort !== 'latest' ? '?' : category || page > 1 ? (category && page > 1 ? '&' : '?') : ''}${sort !== 'latest' ? `sort=${sort}` : ''}${sort !== 'latest' && page > 1 ? '&' : ''}${page > 1 ? `page=${page - 1}` : ''}`}
                  class="inline-flex items-center justify-center w-12 h-12 md:w-10 md:h-10 rounded-full bg-base-100 text-base-700 hover:bg-base-200 hover:text-accent-500 transition-colors touch-target"
                  aria-label="Page précédente"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"/>
                  </svg>
                </a>
              ) : (
                <div class="w-12 h-12 md:w-10 md:h-10"></div>
              )}
              <div class="px-3 py-1.5 md:px-4 md:py-2 rounded-full text-sm font-medium bg-base-100 text-base-600">
                {page}
              </div>
              {hasNext ? (
                <a
                  href={`/${lang}/wallpapers${category ? `?category=${category}` : ''}${category && sort !== 'latest' ? '&' : sort !== 'latest' ? '?' : category ? '&' : '?'}${sort !== 'latest' ? `sort=${sort}&` : ''}page=${page + 1}`}
                  class="inline-flex items-center justify-center w-12 h-12 md:w-10 md:h-10 rounded-full bg-base-100 text-base-700 hover:bg-base-200 hover:text-accent-500 transition-colors touch-target"
                  aria-label="Page suivante"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m9 18 6-6-6-6"/>
                  </svg>
                </a>
              ) : (
                <div class="w-12 h-12 md:w-10 md:h-10"></div>
              )}
            </div>
          )}
        </div>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('wallpapers.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>
