---
export const prerender = true;

export async function getStaticPaths() {
  const langs = ['en', 'fr', 'es', 'ru', 'cn'];
  return langs.map((lang) => ({
    params: { lang },
  }));
}

import BaseLayout from "@/layouts/BaseLayout.astro";
import { Fragment } from "astro/jsx-runtime";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import ResourceCard from "@/components/resources/ResourceCard.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import { loadAllResources, filterAndSortResources, paginateResources } from '@/lib/utils/resource-loader';
import { useTranslations, getLangPrefix } from '@/i18n/utils';
import type { Lang } from '@/i18n/utils';

const lang = (Astro.params.lang || 'en') as Lang;
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = Astro.site || 'https://readme.club';

// Pagination
const url = Astro.url;
const type = url.searchParams.get('type') || null;
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 50;

// Détecter si la page a des paramètres de filtres (à exclure du SEO)
const hasFilters = type !== null || page > 1;

// Charger toutes les resources depuis JSON statique
const allResources = await loadAllResources();

// Filtrer et trier
const filteredResources = filterAndSortResources(allResources, {
  type: type || undefined,
  sortBy: 'created_at',
  sortOrder: 'desc',
});

// Paginer
const pagination = paginateResources(filteredResources, page, limit);
const resources = pagination.data;
const totalPages = pagination.totalPages;

// Générer les pages de pagination
function generatePaginationPages(current: number, total: number): (number | string)[] {
  const pages: (number | string)[] = [];
  
  if (total <= 7) {
    // Afficher toutes les pages si <= 7
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    // Logique de pagination avec ellipses
    if (current <= 3) {
      for (let i = 1; i <= 4; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    } else if (current >= total - 2) {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = total - 3; i <= total; i++) pages.push(i);
    } else {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = current - 1; i <= current + 1; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    }
  }
  
  return pages;
}

const paginationPages = totalPages > 1 ? generatePaginationPages(pagination.currentPage, totalPages) : [];

const resourceTypes = [
  { value: 'tool', label: t('resources.type.tool') },
  { value: 'language_file', label: t('resources.type.language_file') },
  { value: 'plugin', label: t('resources.type.plugin') },
  { value: 'documentation', label: t('resources.type.documentation') },
  { value: 'link', label: t('resources.type.link') },
  { value: 'other', label: t('resources.type.other') },
];
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('resources.title')} - ${t('site.name')}`}
      description={t('resources.subtitle')}
      canonical={`${siteUrl}${langPrefix}/resources`}
      lang={lang}
      noindex={hasFilters}
    />
  </Fragment>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('resources.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('resources.subtitle')}
      </Text>
      <div class="mt-6">
        <a
          href={`/${lang}/submit`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-accent-500 text-base-50 rounded-full hover:bg-accent-600 transition-colors font-medium text-sm shadow-md hover:shadow-lg focus:ring-2 focus:ring-accent-600 focus:ring-offset-2 focus:outline-none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('resources.add_new')}
        </a>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6">
      <div
        class="scrollable-content relative flex snap-x snap-proximity gap-2 py-2 px-2 overflow-x-scroll scrollbar-hide"
      >
        <a
          title={t('common.filter') + ': All'}
          aria-label={t('common.filter') + ': All'}
          href={`/${lang}/resources`}
          class={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${!type ? 'bg-base-900 dark:bg-base-200 text-base-50 dark:text-base-900 hover:bg-base-800 dark:hover:bg-base-300 font-semibold' : 'text-base-900 dark:text-base-50 bg-base-50 dark:bg-base-100 ring-2 ring-base-400 dark:ring-base-600 hover:ring-accent-400 dark:hover:ring-accent-500 hover:bg-accent-50 dark:hover:bg-accent-900/30 font-medium'}`}
        >
          {t('common.filter')}: All
        </a>
        {resourceTypes.map((rt) => (
          <a
            title={rt.label}
            aria-label={rt.label}
            href={`/${lang}/resources?type=${rt.value}`}
            class={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${type === rt.value ? 'bg-base-900 text-base-50 hover:bg-base-800 font-semibold' : 'text-base-900 bg-base-50 ring-2 ring-base-400 hover:ring-accent-400 hover:bg-accent-50 font-medium'}`}
          >
            {rt.label}
          </a>
        ))}
      </div>
      
      <!-- Resources Grid -->
      {resources && resources.length > 0 ? (
        <Fragment>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3 mt-2">
            {resources.map((resource) => (
              <ResourceCard resource={resource} />
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 mt-12">
              {pagination.currentPage > 1 && (
                <a
                  href={`/${lang}/resources${type ? `?type=${type}${pagination.currentPage > 2 ? `&page=${pagination.currentPage - 1}` : ''}` : pagination.currentPage > 2 ? `?page=${pagination.currentPage - 1}` : ''}`}
                  class="px-4 py-2 text-sm text-base-700 bg-base-50 border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.previous')}
                </a>
              )}
              
              <div class="flex items-center gap-1">
                {paginationPages.map((p) => {
                  if (p === 'ellipsis') {
                    return <span class="px-2 text-base-500">...</span>;
                  }
                  const pageNum = p as number;
                  const pageUrl = `/${lang}/resources${type ? `?type=${type}${pageNum > 1 ? `&page=${pageNum}` : ''}` : pageNum > 1 ? `?page=${pageNum}` : ''}`;
                  return (
                    <a
                      href={pageUrl}
                      class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                        pageNum === pagination.currentPage
                          ? 'bg-base-900 dark:bg-base-200 text-base-50 dark:text-base-900'
                          : 'text-base-700 dark:text-base-300 bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 hover:border-accent-300 dark:hover:border-accent-500 hover:text-accent-500 dark:hover:text-accent-400'
                      }`}
                    >
                      {pageNum}
                    </a>
                  );
                })}
              </div>

              {pagination.currentPage < totalPages && (
                <a
                  href={`/${lang}/resources${type ? `?type=${type}&page=${pagination.currentPage + 1}` : `?page=${pagination.currentPage + 1}`}`}
                  class="px-4 py-2 text-sm text-base-700 bg-base-50 border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.next')}
                </a>
              )}
            </div>
          )}
        </Fragment>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('resources.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

