---
export const prerender = false;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import NewsCard from "@/components/news/NewsCard.astro";
import { supabase } from '@/lib/supabase/client';
import { useTranslations } from '@/i18n/utils';
import { normalizeSiteUrl } from '@/lib/utils/url';
import type { Lang } from '@/i18n/utils';

const lang = (Astro.params.lang || 'en') as Lang;
const t = useTranslations(lang);
const siteUrl = normalizeSiteUrl(Astro.site);

// Pagination
const url = Astro.url;
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 12;
const offset = (page - 1) * limit;

// Fetch news articles - order by featured first, then by published_at (or created_at if null), most recent first
const { data: news, error } = await supabase
  .from('news')
  .select('*')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('featured', { ascending: false })
  .order('published_at', { ascending: false, nullsFirst: false })
  .order('created_at', { ascending: false })
  .range(offset, offset + limit - 1);

// Get total count
const { count } = await supabase
  .from('news')
  .select('*', { count: 'exact', head: true })
  .eq('status', 'published')
  .eq('hidden', false);

const totalPages = Math.ceil((count || 0) / limit);

// Generate pagination pages array
const paginationPages: number[] = [];
if (totalPages > 1) {
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
      paginationPages.push(i);
    } else if (i === page - 2 || i === page + 2) {
      paginationPages.push(-1); // -1 represents ellipsis
    }
  }
}
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('news.title')} - ${t('site.name')}`}
      description={t('news.subtitle')}
      canonical={`${siteUrl}/${lang}/news`}
      lang={lang}
    />
  </Fragment>

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('news.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('news.subtitle')}
      </Text>
    </Wrapper>
  </section>

  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      {news && news.length > 0 ? (
        <>
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
            {news.map((article) => (
              <NewsCard news={article} />
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 mt-12">
              {page > 1 && (
                <a
                  href={`/${lang}/news${page > 2 ? `?page=${page - 1}` : ''}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.previous')}
                </a>
              )}
              
              <div class="flex items-center gap-1">
                {paginationPages.map((p) => {
                  if (p === -1) {
                    return <span class="px-2 text-base-500">...</span>;
                  }
                  return (
                    <a
                      href={`/${lang}/news${p > 1 ? `?page=${p}` : ''}`}
                      class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                        p === page
                          ? 'bg-base-900 text-white'
                          : 'text-base-700 bg-white border border-base-200 hover:border-accent-300 hover:text-accent-500'
                      }`}
                    >
                      {p}
                    </a>
                  );
                })}
              </div>

              {page < totalPages && (
                <a
                  href={`/${lang}/news?page=${page + 1}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.next')}
                </a>
              )}
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('news.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

