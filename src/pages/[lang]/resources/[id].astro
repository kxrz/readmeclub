---
export const prerender = true;

export async function getStaticPaths() {
  const langs = ['en', 'fr', 'es', 'ru', 'cn'];
  const resources = await loadAllResources();
  const approvedResources = resources.filter(r => r.status === 'approved' && !r.hidden);
  
  return langs.flatMap((lang) =>
    approvedResources.map((resource) => ({
      params: { lang, id: resource.id },
      props: { resource },
    }))
  );
}

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Link from "@/components/fundations/components/Link.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import SmallResourceCard from "@/components/resources/SmallResourceCard.astro";
import SmallMoreCard from "@/components/resources/SmallMoreCard.astro";
import { useTranslations, getLangPrefix } from '@/i18n/utils';
import { getVibrantGradientForId } from '@/lib/utils/gradients';
import { normalizeSiteUrl, buildUrl } from '@/lib/utils/url';
import { renderMarkdown } from '@/lib/utils/markdown';
import { getResourceContributorName } from '@/lib/utils/author';
import { loadResourceById, loadAllResources } from '@/lib/utils/resource-loader';
import type { Lang } from '@/i18n/utils';
import type { Resource } from '@/lib/supabase/schema';

const lang = (Astro.params.lang || 'en') as Lang;
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = normalizeSiteUrl(Astro.site);

const id = Astro.params.id || Astro.props.resource?.id;

if (!id) {
  return Astro.redirect(`/${lang}/resources`);
}

// Charger la resource depuis JSON statique (ou depuis props si pré-rendu)
const resource = Astro.props.resource || await loadResourceById(id);

if (!resource || resource.status !== 'approved' || resource.hidden) {
  return Astro.redirect(`/${lang}/resources`);
}

// Générer un gradient unique pour cette ressource
const gradient = getVibrantGradientForId(resource.id);
const gradientStyle = `background: linear-gradient(135deg, ${gradient.from} 0%, ${gradient.to} 100%);`;
const textColorStyle = `color: ${gradient.text};`;

const thumbnailUrl = resource.thumbnail_url || `/api/resources/${resource.id}/og-image.png`;
const hasFile = !!resource.file_url;
const hasExternalLink = !!resource.external_link;
const contributorName = getResourceContributorName(resource);

// Vérifier si c'est une image à télécharger
const isImageFile = hasFile && resource.file_name ? /\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i.test(resource.file_name) : false;

// Utiliser le thumbnail_url si disponible, sinon l'image générée par l'API
// Si la ressource est une image, utiliser directement le file_url
const ogImage = resource.thumbnail_url || (isImageFile && resource.file_url ? buildUrl(resource.file_url, siteUrl) : buildUrl(`/api/resources/${resource.id}/og-image.png`, siteUrl));

// Récupérer les ressources star (max 3, excluant la ressource actuelle)
const allResources = await loadAllResources();
const starredResources = allResources
  .filter(r => r.status === 'approved' && !r.hidden && r.starred === true && r.id !== resource.id)
  .sort((a, b) => {
    const dateA = new Date(a.created_at).getTime();
    const dateB = new Date(b.created_at).getTime();
    return dateB - dateA;
  })
  .slice(0, 3);
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${resource.title} - ${t('site.name')}`}
      description={resource.description}
      canonical={`${siteUrl}${langPrefix}/resources/${resource.id}`}
      ogImage={ogImage}
      ogType="article"
      lang={lang}
    />
  </Fragment>
  <section>
    <Wrapper variant="hero">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2">
          <div class="aspect-video w-full overflow-hidden rounded-lg bg-base-100 relative">
            {resource.thumbnail_url || (isImageFile && resource.file_url) ? (
              <>
                <img
                  src={isImageFile && resource.file_url ? resource.file_url : thumbnailUrl}
                  alt={resource.title}
                  class="h-full w-full object-cover"
                  onerror={`this.style.display='none'; this.nextElementSibling.style.display='flex';`}
                />
                <div class="h-full w-full flex items-center justify-center absolute inset-0" style={`display: none; ${gradientStyle}`}>
                  <Text tag="span" variant="displaySM" class="font-semibold px-8 text-center" style={textColorStyle}>
                    {resource.title}
                  </Text>
                </div>
                {isImageFile && resource.file_url && (
                  <a
                    href={`/api/resources/${resource.id}/download`}
                    class="absolute top-4 right-4 bg-base-50/90 hover:bg-base-50 rounded-full p-3 shadow-lg transition-all group resource-download-link"
                    data-resource-id={resource.id}
                    title={t('resources.download_file')}
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="icon icon-tabler icons-tabler-outline icon-tabler-download size-5 text-base-900 group-hover:text-accent-500"
                    >
                      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                      <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                      <path d="M7 11l5 5l5 -5"></path>
                      <path d="M12 4l0 12"></path>
                    </svg>
                  </a>
                )}
              </>
            ) : (
              <div class="h-full w-full flex items-center justify-center" style={gradientStyle}>
                <Text tag="span" variant="displaySM" class="font-semibold px-8 text-center" style={textColorStyle}>
                  {resource.title}
                </Text>
              </div>
            )}
          </div>
        </div>
        <div class="flex flex-col h-full justify-between">
          <div>
            <Text
              tag="h1"
              variant="displaySM"
              class="text-base-900 mt-12 font-medium 2xl:text-5xl tracking-tight"
            >
              {resource.title}
            </Text>
            <div
              class="mt-4 text-base-700 text-balance prose prose-sm max-w-none prose-headings:text-base-900 prose-headings:font-semibold prose-p:text-base-700 prose-a:text-accent-500 prose-a:no-underline hover:prose-a:underline prose-strong:text-base-900 prose-ul:text-base-700 prose-ol:text-base-700 prose-li:text-base-700 prose-code:text-base-900 prose-code:bg-base-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-sm"
              set:html={renderMarkdown(resource.description)}
            />
            <Text
              tag="p"
              variant="textBase"
              class="text-base-900 mt-12 font-medium uppercase"
            >
              Details
            </Text>
            <dl class="relative flex flex-col gap-4 mt-4 w-full">
              <div class="flex items-center lg:justify-between">
                <dt class="flex-1">
                  <Text
                    tag="p"
                    variant="textSM"
                    class="text-base-900 font-medium flex justify-between"
                  >
                    <span>Type</span>
                    <span class="flex-1 mx-2 border-dotted border-b border-base-300" />
                  </Text>
                </dt>
                <dd class="mt-1 text-base-600">
                  <Text tag="p" variant="textSM" class="text-base-600">
                    {t(`resources.type.${resource.type}`)}
                  </Text>
                </dd>
              </div>
              <div class="flex items-center lg:justify-between">
                <dt class="flex-1">
                  <Text
                    tag="p"
                    variant="textSM"
                    class="text-base-900 font-medium flex justify-between"
                  >
                    <span>Downloads</span>
                    <span class="flex-1 mx-2 border-dotted border-b border-base-300" />
                  </Text>
                </dt>
                <dd class="mt-1 text-base-600">
                  <Text tag="p" variant="textSM" class="text-base-600">
                    {t('resources.downloads', { count: resource.downloads_count })}
                  </Text>
                </dd>
              </div>
              {resource.version && (
                <div class="flex items-center lg:justify-between">
                  <dt class="flex-1">
                    <Text
                      tag="p"
                      variant="textSM"
                      class="text-base-900 font-medium flex justify-between"
                    >
                      <span>{t('resources.version')}</span>
                      <span class="flex-1 mx-2 border-dotted border-b border-base-300" />
                    </Text>
                  </dt>
                  <dd class="mt-1 text-base-600">
                    <Text tag="p" variant="textSM" class="text-base-600">
                      {resource.version}
                    </Text>
                  </dd>
                </div>
              )}
              {resource.compatibility && (
                <div class="flex items-center lg:justify-between">
                  <dt class="flex-1">
                    <Text
                      tag="p"
                      variant="textSM"
                      class="text-base-900 font-medium flex justify-between"
                    >
                      <span>{t('resources.compatibility')}</span>
                      <span class="flex-1 mx-2 border-dotted border-b border-base-300" />
                    </Text>
                  </dt>
                  <dd class="mt-1 text-base-600">
                    <Text tag="p" variant="textSM" class="text-base-600">
                      {resource.compatibility}
                    </Text>
                  </dd>
                </div>
              )}
              {contributorName && (
                <div class="flex items-center lg:justify-between">
                  <dt class="flex-1">
                    <Text
                      tag="p"
                      variant="textSM"
                      class="text-base-900 font-medium flex justify-between"
                    >
                      <span>{t('resources.contributor')}</span>
                      <span class="flex-1 mx-2 border-dotted border-b border-base-300" />
                    </Text>
                  </dt>
                  <dd class="mt-1 text-base-600">
                    <Text tag="p" variant="textSM" class="text-base-600">
                      {contributorName}
                    </Text>
                  </dd>
                </div>
              )}
            </dl>
          </div>

          <div class="flex items-center mt-8 justify-between">
            {hasFile && (
              <a
                href={`/api/resources/${resource.id}/download`}
                class="block resource-download-link"
                data-resource-id={resource.id}
              >
                <Button
                  variant="accent"
                  size="xs"
                  class="justify-center flex items-center gap-1 w-auto"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="icon icon-tabler icons-tabler-outline icon-tabler-download size-4"
                  >
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                    <path d="M7 11l5 5l5 -5"></path>
                    <path d="M12 4l0 12"></path>
                  </svg>
                  {t('resources.download_file')}
                </Button>
              </a>
            )}
            {hasExternalLink && (
              <Link
                size="xs"
                variant="ghost"
                href={resource.external_link}
                target="_blank"
                rel="noopener noreferrer"
                title={resource.title}
                class="justify-center flex items-center gap-1 w-auto"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="icon icon-tabler icons-tabler-outline icon-tabler-link size-4"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M9 15l6 -6"></path>
                  <path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464"></path>
                  <path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463"></path>
                </svg>
                {t('resources.visit_link')}
              </Link>
            )}
          </div>
        </div>
      </div>
    </Wrapper>
  </section>
  <section>
    <Wrapper variant="standard">
      <div class="max-w-2xl">
        {resource.installation_instructions && (
          <div class="mb-8">
            <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-3">
              {t('resources.installation')}
            </Text>
            <div class="bg-base-50 rounded-lg p-4">
              <Text tag="p" variant="textSM" class="text-base-700 whitespace-pre-line">
                {resource.installation_instructions}
              </Text>
            </div>
          </div>
        )}
        
        {resource.known_issues && (
          <div class="mb-8">
            <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-3">
              {t('resources.known_issues')}
            </Text>
            <div class="bg-yellow-50 rounded-lg p-4">
              <Text tag="p" variant="textSM" class="text-base-700 whitespace-pre-line">
                {resource.known_issues}
              </Text>
            </div>
          </div>
        )}
        
        {resource.tags && resource.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {resource.tags.map((tag) => (
              <span class="text-sm text-base-600 bg-base-100 px-3 py-1 rounded-full">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </Wrapper>
  </section>
  
  <!-- Starred Resources Section -->
  {starredResources && starredResources.length > 0 ? (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.starred_resources')}
          </Text>
          <Link
            href={`/${lang}/resources`}
            variant="link"
            class="text-base-600 text-xs uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            See all resources
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Link>
        </div>
        <div class="grid grid-cols-1 gap-2 md:grid-cols-2 xl:grid-cols-4 mt-4">
          {starredResources && starredResources.map((starredResource) => (
            <SmallResourceCard resource={starredResource} />
          ))}
          <SmallMoreCard href={`/${lang}/resources`} label={t('common.view') + ' all'} />
        </div>
      </Wrapper>
    </section>
  ) : null}
  <script>
    // Track resource downloads
    (function() {
      const downloadLinks = document.querySelectorAll('.resource-download-link');
      const trackedIds = new Set();
      
      downloadLinks.forEach(link => {
        link.addEventListener('click', function() {
          const resourceId = this.getAttribute('data-resource-id');
          
          if (!resourceId || trackedIds.has(resourceId)) {
            return;
          }
          
          trackedIds.add(resourceId);
        });
      });
    })();
  </script>
</BaseLayout>

