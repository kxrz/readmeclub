---
export const prerender = false;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import Breadcrumb from "@/components/common/Breadcrumb.astro";
import SmallNewsCard from "@/components/news/SmallNewsCard.astro";
import { supabase } from '@/lib/supabase/client';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';
import { normalizeSiteUrl, buildUrl } from '@/lib/utils/url';
import type { News } from '@/lib/supabase/schema';
import { marked } from 'marked';

// Configure marked with custom renderer for external links
const renderer = new marked.Renderer();
const defaultLinkRenderer = renderer.link.bind(renderer);

// Custom link renderer to add target="_blank" and UTM to external links
renderer.link = function(href, title, text) {
  // Use default renderer first to get proper HTML
  const defaultHtml = defaultLinkRenderer(href, title, text);
  
  // If href is invalid, return default
  if (!href || typeof href !== 'string' || href.trim() === '' || href === 'undefined') {
    return defaultHtml;
  }
  
  // Check if external link
  const isExternal = href.startsWith('http://') || href.startsWith('https://');
  
  if (isExternal) {
    try {
      // Add UTM parameters to external links
      const url = new URL(href);
      url.searchParams.set('utm_source', 'readme.club');
      url.searchParams.set('utm_medium', 'referral');
      const finalHref = url.toString();
      
      // Modify the default HTML to add target="_blank" and update href
      return defaultHtml
        .replace(/href="[^"]*"/, `href="${finalHref}"`)
        .replace(/<a /, '<a target="_blank" rel="noopener noreferrer" ');
    } catch (e) {
      // If URL parsing fails, just add target="_blank" to default HTML
      return defaultHtml.replace(/<a /, '<a target="_blank" rel="noopener noreferrer" ');
    }
  }
  
  // Internal links - return default HTML unchanged
  return defaultHtml;
};

marked.setOptions({
  breaks: true,
  gfm: true,
  renderer: renderer,
});

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = normalizeSiteUrl(Astro.site);

const slug = Astro.params.slug;

if (!slug) {
  return Astro.redirect(`${langPrefix}/news`);
}

// Fetch article
const { data: article, error } = await supabase
  .from('news')
  .select('*')
  .eq('slug', slug)
  .eq('status', 'published')
  .eq('hidden', false)
  .single();

if (error || !article) {
  return Astro.redirect(`${langPrefix}/news`);
}

// Increment views count using admin client (has permissions to update)
const supabaseAdmin = getSupabaseAdmin();
const { error: incrementError } = await supabaseAdmin.rpc('increment_news_views', { news_id: article.id });
if (incrementError) {
  console.error('Error incrementing news views:', incrementError);
} else {
  // Fetch updated article to get the new views_count
  const { data: updatedArticle } = await supabase
    .from('news')
    .select('views_count')
    .eq('id', article.id)
    .single();
  
  if (updatedArticle) {
    article.views_count = updatedArticle.views_count;
  }
}

// Fetch recent articles (excluding current) - order by published_at (or created_at if null), most recent first
const { data: recentArticles } = await supabase
  .from('news')
  .select('*')
  .eq('status', 'published')
  .eq('hidden', false)
  .neq('id', article.id)
  .order('published_at', { ascending: false, nullsFirst: false })
  .order('created_at', { ascending: false })
  .limit(3);

const publishedDate = article.published_at ? new Date(article.published_at) : new Date(article.created_at);
const formattedDate = publishedDate.toLocaleDateString(lang === 'en' ? 'en-US' : lang === 'fr' ? 'fr-FR' : lang === 'es' ? 'es-ES' : lang === 'ru' ? 'ru-RU' : 'zh-CN', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const ogImage = article.featured_image_url || buildUrl(`/api/news/${article.id}/og-image.png`, siteUrl);

// Breadcrumb items
const breadcrumbItems = [
  { label: t('nav.home'), href: langPrefix || '/' },
  { label: t('news.title'), href: `${langPrefix}/news` },
  { label: article.title },
];
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${article.title} - ${t('site.name')}`}
      description={article.excerpt || article.title}
      canonical={`${siteUrl}${langPrefix}/news/${article.slug}`}
      ogImage={ogImage}
      ogType="article"
      lang={lang}
    />
    
    {/* Article structured data */}
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": article.title,
      "description": article.excerpt || article.title,
      "image": ogImage,
      "datePublished": article.published_at || article.created_at,
      "dateModified": article.updated_at,
      "author": {
        "@type": "Person",
        "name": article.author_name || "readme.club"
      },
      "publisher": {
        "@type": "Organization",
        "name": "readme.club",
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/icon.svg`
        }
      }
    })} />
  </Fragment>

  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <Breadcrumb items={breadcrumbItems} />

      <article class="max-w-4xl mx-auto">
        {article.featured && (
          <span class="inline-block mb-4 text-xs uppercase text-accent-600 font-semibold">
            {t('news.featured')}
          </span>
        )}

        <Text
          tag="h1"
          variant="displaySM"
          class="text-base-900 font-medium 2xl:text-5xl tracking-tight mb-6"
        >
          {article.title}
        </Text>

        <div class="flex items-center gap-4 mb-8 text-sm text-base-600">
          {article.author_name && (
            <span>{t('news.by')} {article.author_name}</span>
          )}
          <time datetime={publishedDate.toISOString()}>{formattedDate}</time>
          {article.views_count > 0 && (
            <span>{article.views_count} {t('news.views')}</span>
          )}
        </div>

        <div class="mb-8 rounded-lg overflow-hidden">
          {article.featured_image_url ? (
            <img
              src={article.featured_image_url}
              alt={article.title}
              class="w-full h-auto"
              loading="eager"
              onerror="this.onerror=null; this.src=this.dataset.fallback;"
              data-fallback={buildUrl(`/api/news/${article.id}/og-image.png`, siteUrl)}
            />
          ) : (
            <img
              src={buildUrl(`/api/news/${article.id}/og-image.png`, siteUrl)}
              alt={article.title}
              class="w-full h-auto"
              loading="eager"
            />
          )}
        </div>

        <div class="prose prose-lg max-w-none">
          <div set:html={marked.parse(article.content)} />
        </div>
      </article>

      {recentArticles && recentArticles.length > 0 && (
        <div class="mt-16 pt-8 border-t border-base-200">
          <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-6">
            {t('news.recent_articles')}
          </Text>
          <div class="space-y-2">
            {recentArticles.map((recent) => (
              <SmallNewsCard news={recent} />
            ))}
          </div>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

