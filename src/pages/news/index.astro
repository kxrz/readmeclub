---
export const prerender = false; // SSR pour permettre l'affichage des nouveaux articles sans rebuild

import BaseLayout from "@/layouts/BaseLayout.astro";
import { Fragment } from "astro/jsx-runtime";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import Link from "@/components/fundations/components/Link.astro";
import NewsCard from "@/components/news/NewsCard.astro";
import NewsletterCTA from "@/components/newsletter/NewsletterCTA.astro";
import { normalizeSiteUrl } from '@/lib/utils/url';
import { loadAllNewsArticles, paginateNews } from '@/lib/utils/news-loader';

const siteUrl = normalizeSiteUrl(Astro.site);

// Pagination
const url = Astro.url;
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 20;

// Charger tous les articles
const allNews = await loadAllNewsArticles();

// Paginer
const pagination = paginateNews(allNews, page, limit);
const news = pagination.data;
const totalPages = pagination.totalPages;
const currentPage = pagination.currentPage;

// Générer les pages de pagination
function generatePaginationPages(current: number, total: number): (number | string)[] {
  const pages: (number | string)[] = [];
  
  if (total <= 7) {
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    if (current <= 3) {
      for (let i = 1; i <= 4; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    } else if (current >= total - 2) {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = total - 3; i <= total; i++) pages.push(i);
    } else {
      pages.push(1);
      pages.push('ellipsis');
      for (let i = current - 1; i <= current + 1; i++) pages.push(i);
      pages.push('ellipsis');
      pages.push(total);
    }
  }
  
  return pages;
}

const paginationPages = totalPages > 1 ? generatePaginationPages(currentPage, totalPages) : [];
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title="News - readme.club"
      description="Latest updates and discussions from the Xteink community"
      canonical={`${siteUrl}/news`}
      lang="en"
    />
    <link rel="alternate" type="application/rss+xml" href={`${siteUrl}/news/rss.xml`} />
  </Fragment>

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        News
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        Latest updates and articles from the Xteink community
      </Text>

      {/* Newsletter CTA and RSS Button */}
      <div class="mt-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center">
        <div class="flex-1 max-w-md">
          <NewsletterCTA source="news" compact={true} horizontal={true} />
        </div>
        <a
          href={`${siteUrl}/news/rss.xml`}
          type="application/rss+xml"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm text-base-700 bg-base-50 border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors whitespace-nowrap"
          aria-label="RSS Feed"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M4 11a9 9 0 0 1 9 9"/>
            <path d="M4 4a16 16 0 0 1 16 16"/>
            <circle cx="5" cy="19" r="1"/>
          </svg>
          RSS Feed
        </a>
      </div>
    </Wrapper>
  </section>

  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      {news.length > 0 ? (
        <>
          {/* Grille d'articles */}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            {news.map((article) => (
              <NewsCard news={article} />
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 flex-wrap">
              {currentPage > 1 && (
                <Link
                  href={`/news${currentPage > 2 ? `?page=${currentPage - 1}` : ''}`}
                  class="px-4 py-2 text-sm text-base-700 bg-base-50 border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  Previous
                </Link>
              )}
              
              <div class="flex items-center gap-1">
                {paginationPages.map((p) => {
                  if (p === 'ellipsis') {
                    return <span class="px-2 text-base-500">...</span>;
                  }
                  const pageNum = p as number;
                  const isActive = pageNum === currentPage;
                  return (
                    <Link
                      href={`/news${pageNum > 1 ? `?page=${pageNum}` : ''}`}
                      class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                        isActive
                          ? 'bg-base-900 text-base-50'
                          : 'text-base-700 bg-base-50 border border-base-200 hover:border-accent-300 hover:text-accent-500'
                      }`}
                    >
                      {pageNum}
                    </Link>
                  );
                })}
              </div>

              {currentPage < totalPages && (
                <Link
                  href={`/news?page=${currentPage + 1}`}
                  class="px-4 py-2 text-sm text-base-700 bg-base-50 border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  Next
                </Link>
              )}
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-600">
            No news articles found.
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>
