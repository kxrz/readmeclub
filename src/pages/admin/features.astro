---
export const prerender = false; // Page admin dynamique, utilise Astro.request.headers

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { checkAdminAuth } from '@/lib/utils/admin';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Check admin auth
if (!checkAdminAuth(Astro.cookies)) {
  return Astro.redirect('/admin');
}

// Fetch all feature requests (including hidden)
const supabaseAdmin = getSupabaseAdmin();
const { data: features } = await supabaseAdmin
  .from('feature_requests')
  .select('*')
  .order('created_at', { ascending: false });
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <div class="flex items-center justify-between">
        <Text
          tag="h1"
          variant="displaySM"
          class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
        >
          {t('admin.features')}
        </Text>
        <div class="flex items-center gap-4">
          <a href="/admin/stats">
            <Button variant="muted" size="sm">
              Stats
            </Button>
          </a>
          <a href="/admin/resources">
            <Button variant="muted" size="sm">
              Resources
            </Button>
          </a>
          <a href="/admin/wallpapers">
            <Button variant="muted" size="sm">
              Wallpapers
            </Button>
          </a>
          <a href="/admin/news">
            <Button variant="muted" size="sm">
              News
            </Button>
          </a>
          <a href="/admin/logout">
            <Button variant="muted" size="sm">
              {t('admin.logout')}
            </Button>
          </a>
        </div>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <div class="space-y-4">
        {features && features.length > 0 ? (
          features.map((feature) => (
            <div
              class="flex items-center justify-between p-4 border border-base-200 rounded-lg hover:bg-base-50"
            >
              <div class="flex-1">
                <Text tag="h3" variant="textBase" class="font-semibold text-base-900">
                  {feature.title}
                </Text>
                <div class="flex items-center gap-4 mt-2">
                  <span class={`text-xs px-2 py-1 rounded ${
                    feature.admin_status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                    feature.admin_status === 'planned' ? 'bg-blue-100 text-blue-700' :
                    feature.admin_status === 'completed' ? 'bg-green-100 text-green-700' :
                    'bg-red-100 text-red-700'
                  }`}>
                    {t(`board.status.${feature.admin_status}`)}
                  </span>
                  {feature.hidden && (
                    <span class="text-xs text-base-500">Hidden</span>
                  )}
                  <span class="text-xs text-base-500">
                    {t('board.votes', { count: feature.votes_count })}
                  </span>
                  {feature.reddit_username && (
                    <span class="text-xs text-base-500">
                      @{feature.reddit_username}
                    </span>
                  )}
                </div>
                <Text tag="p" variant="textSM" class="text-base-600 mt-1 line-clamp-2">
                  {feature.description}
                </Text>
              </div>
              <div class="flex items-center gap-2">
                <select
                  class="px-3 py-2 text-sm border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400"
                  onchange={`updateStatus('${feature.id}', this.value)`}
                  value={feature.admin_status}
                >
                  <option value="pending">{t('board.status.pending')}</option>
                  <option value="planned">{t('board.status.planned')}</option>
                  <option value="completed">{t('board.status.completed')}</option>
                  <option value="rejected">{t('board.status.rejected')}</option>
                </select>
                <button
                  class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                    feature.hidden 
                      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                      : 'bg-base-100 hover:bg-base-200'
                  }`}
                  onclick={`toggleHidden('${feature.id}', ${!feature.hidden})`}
                >
                  {feature.hidden ? 'Show' : 'Hide'}
                </button>
                <a
                  href={`/board`}
                  target="_blank"
                  class="px-4 py-2 text-sm bg-accent-500 text-base-50 hover:bg-accent-600 rounded-lg transition-colors"
                >
                  {t('common.view')}
                </a>
              </div>
            </div>
          ))
        ) : (
          <Text tag="p" variant="textBase" class="text-base-500 text-center py-12">
            No feature requests found
          </Text>
        )}
      </div>
    </Wrapper>
  </section>
</BaseLayout>

<script>
  async function toggleHidden(id: string, hidden: boolean) {
    try {
      const res = await fetch(`/api/admin/features/${id}/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hidden }),
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to toggle');
      }
      
      window.location.reload();
    } catch (error: any) {
      alert(error.message || 'An error occurred');
    }
  }
  
  async function updateStatus(id: string, adminStatus: string) {
    try {
      const res = await fetch(`/api/admin/features/${id}/update`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ admin_status: adminStatus }),
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to update');
      }
      
      window.location.reload();
    } catch (error: any) {
      alert(error.message || 'An error occurred');
      window.location.reload();
    }
  }
  
  // Make functions available globally
  (window as any).toggleHidden = toggleHidden;
  (window as any).updateStatus = updateStatus;
</script>

