---
export const prerender = false; // Page admin dynamique, nécessite SSR

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { checkAdminAuth } from '@/lib/utils/admin';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Check admin auth
if (!checkAdminAuth(Astro.cookies)) {
  return Astro.redirect('/admin');
}

// Fetch all resources (including hidden)
const supabaseAdmin = getSupabaseAdmin();
const { data: resources } = await supabaseAdmin
  .from('resources')
  .select('*')
  .order('created_at', { ascending: false });
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <div class="flex items-center justify-between">
        <Text
          tag="h1"
          variant="displaySM"
          class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
        >
          {t('admin.resources')}
        </Text>
        <div class="flex items-center gap-4">
          <a href="/admin/stats">
            <Button variant="muted" size="sm">
              Stats
            </Button>
          </a>
          <a href="/admin/features">
            <Button variant="muted" size="sm">
              Features
            </Button>
          </a>
          <a href="/admin/wallpapers">
            <Button variant="muted" size="sm">
              Wallpapers
            </Button>
          </a>
          <a href="/admin/news">
            <Button variant="muted" size="sm">
              News
            </Button>
          </a>
          <a href="/admin/logout">
            <Button variant="muted" size="sm">
              {t('admin.logout')}
            </Button>
          </a>
        </div>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <div class="space-y-4">
        {resources && resources.length > 0 ? (
          resources.map((resource) => (
            <div
              class="flex items-center justify-between p-4 border border-base-200 rounded-lg hover:bg-base-50"
            >
              <div class="flex-1">
                <Text tag="h3" variant="textBase" class="font-semibold text-base-900">
                  {resource.title}
                </Text>
                <div class="flex items-center gap-4 mt-2">
                  <span class={`text-xs px-2 py-1 rounded ${
                    resource.status === 'approved' ? 'bg-green-100 text-green-700' :
                    resource.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                    'bg-red-100 text-red-700'
                  }`}>
                    {resource.status}
                  </span>
                  {resource.hidden && (
                    <span class="text-xs text-base-500">Hidden</span>
                  )}
                  {resource.starred && (
                    <span class="text-xs text-yellow-600">⭐ Starred</span>
                  )}
                  <span class="text-xs text-base-500">
                    {t('resources.downloads', { count: resource.downloads_count })}
                  </span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button
                  class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                    resource.starred 
                      ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' 
                      : 'bg-base-100 hover:bg-base-200'
                  }`}
                  onclick={`toggleStarred('${resource.id}', ${!resource.starred})`}
                  title={resource.starred ? 'Unstar' : 'Star'}
                >
                  {resource.starred ? '⭐' : '☆'}
                </button>
                <button
                  class="px-4 py-2 text-sm bg-base-100 hover:bg-base-200 rounded-lg transition-colors"
                  onclick={`toggleHidden('${resource.id}', ${!resource.hidden})`}
                >
                  {resource.hidden ? 'Show' : 'Hide'}
                </button>
                <button
                  class="px-4 py-2 text-sm bg-blue-500 text-white hover:bg-blue-600 rounded-lg transition-colors"
                  onclick={`openEditModal('${resource.id}')`}
                >
                  {t('common.edit')}
                </button>
                <a
                  href={`/resources/${resource.id}`}
                  target="_blank"
                  class="px-4 py-2 text-sm bg-accent-500 text-white hover:bg-accent-600 rounded-lg transition-colors"
                >
                  {t('common.view')}
                </a>
              </div>
            </div>
          ))
        ) : (
          <Text tag="p" variant="textBase" class="text-base-500 text-center py-12">
            No resources found
          </Text>
        )}
      </div>
    </Wrapper>
  </section>
  
  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <Text tag="h2" variant="textXL" class="font-semibold text-base-900">
            {t('admin.edit_resource')}
          </Text>
          <button
            onclick="closeEditModal()"
            class="text-base-500 hover:text-base-900 transition-colors"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <form id="editForm" onsubmit="handleEditSubmit(event)">
          <input type="hidden" id="editResourceId" />
          
          <div class="space-y-4">
            <!-- Type -->
            <div>
              <label for="editType" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.type.label')}
              </label>
              <select
                id="editType"
                name="type"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                required
              >
                <option value="tool">{t('resources.type.tool')}</option>
                <option value="language_file">{t('resources.type.language_file')}</option>
                <option value="plugin">{t('resources.type.plugin')}</option>
                <option value="link">{t('resources.type.link')}</option>
                <option value="documentation">{t('resources.type.documentation')}</option>
                <option value="info">{t('resources.type.info')}</option>
                <option value="other">{t('resources.type.other')}</option>
              </select>
            </div>
            
            <!-- Title -->
            <div>
              <label for="editTitle" class="block text-sm font-medium text-base-900 mb-2">
                {t('form.title')}
              </label>
              <input
                type="text"
                id="editTitle"
                name="title"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                required
              />
            </div>
            
            <!-- Description -->
            <div>
              <label for="editDescription" class="block text-sm font-medium text-base-900 mb-2">
                {t('form.description')}
              </label>
              <textarea
                id="editDescription"
                name="description"
                rows="4"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                required
              ></textarea>
            </div>
            
            <!-- File URL -->
            <div>
              <label for="editFileUrl" class="block text-sm font-medium text-base-900 mb-2">
                {t('form.file_url')} ({t('common.optional')})
              </label>
              <input
                type="url"
                id="editFileUrl"
                name="file_url"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder="https://..."
              />
            </div>
            
            <!-- External Link -->
            <div>
              <label for="editExternalLink" class="block text-sm font-medium text-base-900 mb-2">
                {t('form.external_link')} ({t('common.optional')})
              </label>
              <input
                type="url"
                id="editExternalLink"
                name="external_link"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder="https://..."
              />
            </div>
            
            <!-- Thumbnail URL -->
            <div>
              <label for="editThumbnailUrl" class="block text-sm font-medium text-base-900 mb-2">
                {t('form.thumbnail_url')} ({t('common.optional')})
              </label>
              <input
                type="url"
                id="editThumbnailUrl"
                name="thumbnail_url"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder="https://..."
              />
            </div>
            
            <!-- Version -->
            <div>
              <label for="editVersion" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.version')} ({t('common.optional')})
              </label>
              <input
                type="text"
                id="editVersion"
                name="version"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.version_placeholder')}
              />
            </div>
            
            <!-- Compatibility -->
            <div>
              <label for="editCompatibility" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.compatibility')} ({t('common.optional')})
              </label>
              <input
                type="text"
                id="editCompatibility"
                name="compatibility"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.compatibility_placeholder')}
              />
            </div>
            
            <!-- Installation Instructions -->
            <div>
              <label for="editInstallation" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.installation')} ({t('common.optional')})
              </label>
              <textarea
                id="editInstallation"
                name="installation_instructions"
                rows="3"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.installation_placeholder')}
              ></textarea>
            </div>
            
            <!-- Known Issues -->
            <div>
              <label for="editKnownIssues" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.known_issues')} ({t('common.optional')})
              </label>
              <textarea
                id="editKnownIssues"
                name="known_issues"
                rows="3"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.known_issues_placeholder')}
              ></textarea>
            </div>
            
            <!-- Contributor Name -->
            <div>
              <label for="editContributorName" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.contributor')} ({t('common.optional')})
              </label>
              <input
                type="text"
                id="editContributorName"
                name="contributor_name"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.contributor_name_placeholder')}
              />
            </div>
            
            <!-- Contact Info -->
            <div>
              <label for="editContactInfo" class="block text-sm font-medium text-base-900 mb-2">
                {t('resources.contact')} ({t('common.optional')})
              </label>
              <input
                type="text"
                id="editContactInfo"
                name="contact_info"
                class="w-full px-4 py-2 border border-base-200 rounded-lg focus:ring-2 focus:ring-accent-400 focus:border-accent-400"
                placeholder={t('form.contact_info_placeholder')}
              />
            </div>
          </div>
          
          <div class="flex items-center justify-end gap-4 mt-6">
            <button
              type="button"
              onclick="closeEditModal()"
              class="px-4 py-2 text-sm bg-base-100 hover:bg-base-200 rounded-lg transition-colors"
            >
              {t('common.cancel')}
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm bg-accent-500 text-white hover:bg-accent-600 rounded-lg transition-colors"
            >
              {t('admin.save_changes')}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  async function toggleHidden(id: string, hidden: boolean) {
    try {
      const res = await fetch(`/api/admin/resources/${id}/toggle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hidden }),
      });
      
      if (!res.ok) {
        throw new Error('Failed to toggle');
      }
      
      window.location.reload();
    } catch (error) {
      alert('Failed to toggle resource visibility');
    }
  }
  
  async function toggleStarred(id: string, starred: boolean) {
    try {
      const res = await fetch(`/api/admin/resources/${id}/star`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ starred }),
      });
      
      if (!res.ok) {
        throw new Error('Failed to toggle');
      }
      
      window.location.reload();
    } catch (error) {
      alert('Failed to toggle resource star status');
    }
  }
  
  let currentResource: any = null;
  
  async function openEditModal(id: string) {
    try {
      // Fetch resource details (using admin endpoint to get all resources, even hidden ones)
      const res = await fetch(`/api/admin/resources/${id}`);
      if (!res.ok) {
        throw new Error('Failed to fetch resource');
      }
      
      currentResource = await res.json();
      
      // Populate form
      (document.getElementById('editResourceId') as HTMLInputElement).value = currentResource.id;
      (document.getElementById('editType') as HTMLSelectElement).value = currentResource.type;
      (document.getElementById('editTitle') as HTMLInputElement).value = currentResource.title || '';
      (document.getElementById('editDescription') as HTMLTextAreaElement).value = currentResource.description || '';
      (document.getElementById('editFileUrl') as HTMLInputElement).value = currentResource.file_url || '';
      (document.getElementById('editExternalLink') as HTMLInputElement).value = currentResource.external_link || '';
      (document.getElementById('editThumbnailUrl') as HTMLInputElement).value = currentResource.thumbnail_url || '';
      (document.getElementById('editVersion') as HTMLInputElement).value = currentResource.version || '';
      (document.getElementById('editCompatibility') as HTMLInputElement).value = currentResource.compatibility || '';
      (document.getElementById('editInstallation') as HTMLTextAreaElement).value = currentResource.installation_instructions || '';
      (document.getElementById('editKnownIssues') as HTMLTextAreaElement).value = currentResource.known_issues || '';
      (document.getElementById('editContributorName') as HTMLInputElement).value = currentResource.contributor_name || '';
      (document.getElementById('editContactInfo') as HTMLInputElement).value = currentResource.contact_info || '';
      
      // Show modal
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.remove('hidden');
      }
    } catch (error) {
      alert('Failed to load resource details');
      console.error(error);
    }
  }
  
  function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
      modal.classList.add('hidden');
    }
    currentResource = null;
  }
  
  async function handleEditSubmit(event: Event) {
    event.preventDefault();
    
    if (!currentResource) {
      return;
    }
    
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);
    
    const updateData: Record<string, any> = {};
    
    // Collect form values
    const fields = [
      'type', 'title', 'description', 'file_url', 'external_link', 
      'thumbnail_url', 'version', 'compatibility', 'installation_instructions',
      'known_issues', 'contributor_name', 'contact_info'
    ];
    
    fields.forEach(field => {
      const value = formData.get(field);
      if (value !== null && value !== '') {
        updateData[field] = value.toString();
      } else {
        // Set to null to clear the field
        updateData[field] = null;
      }
    });
    
    try {
      const res = await fetch(`/api/admin/resources/${currentResource.id}/update`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData),
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to update resource');
      }
      
      alert('Resource updated successfully');
      closeEditModal();
      window.location.reload();
    } catch (error: any) {
      alert(`Failed to update resource: ${error.message}`);
      console.error(error);
    }
  }
  
  // Make functions available globally
  (window as any).toggleHidden = toggleHidden;
  (window as any).toggleStarred = toggleStarred;
  (window as any).openEditModal = openEditModal;
  (window as any).closeEditModal = closeEditModal;
  (window as any).handleEditSubmit = handleEditSubmit;
</script>

