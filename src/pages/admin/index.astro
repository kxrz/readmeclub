---
export const prerender = false; // Page admin dynamique, n√©cessite SSR

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Check if already authenticated
const adminCookie = Astro.cookies.get('admin_session');
const isAuthenticated = adminCookie?.value === 'authenticated';

if (isAuthenticated) {
  return Astro.redirect('/admin/resources');
}
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('admin.login')}
      </Text>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6 pb-24 max-w-md mx-auto">
      <form
        id="admin-login-form"
        class="space-y-6"
        x-data="{ loading: false, error: null }"
      >
        <div>
          <label for="password" class="block text-sm font-medium text-base-700 mb-2">
            {t('admin.password')}
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="w-full px-4 py-2 border border-base-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
          />
        </div>
        
        <div x-show="error" class="text-red-600 text-sm" style="display: none;">
          <span x-text="error"></span>
        </div>
        
        <Button
          type="submit"
          variant="accent"
          size="lg"
          class="w-full"
          x-bind:disabled="loading"
        >
          <span x-show="!loading">{t('admin.login_button')}</span>
          <span x-show="loading">{t('common.loading')}</span>
        </Button>
      </form>
    </Wrapper>
  </section>
</BaseLayout>

<script>
  document.getElementById('admin-login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const password = formData.get('password') as string;
    
    try {
      const res = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password }),
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Login failed');
      }
      
      window.location.href = '/admin/resources';
    } catch (error: any) {
      const errorDiv = form.querySelector('[x-show="error"]') as HTMLElement;
      if (errorDiv) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }
  });
</script>

