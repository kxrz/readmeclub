---
export const prerender = false; // Page admin dynamique, nécessite SSR

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { checkAdminAuth } from '@/lib/utils/admin';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Check admin auth
if (!checkAdminAuth(Astro.cookies)) {
  return Astro.redirect('/admin');
}

// Récupérer le paramètre de jours (par défaut 7)
const url = Astro.url;
const daysParam = url.searchParams.get('days');
const days = daysParam ? parseInt(daysParam) : 7;

// Fetch weekly report directement depuis Supabase
const supabaseAdmin = getSupabaseAdmin();
const startDate = new Date();
startDate.setDate(startDate.getDate() - days);
const endDate = new Date();

let reportData: any = null;
try {
  // Récupérer les ressources
  const { data: resources } = await supabaseAdmin
    .from('resources')
    .select('id, title, description, type, created_at, external_link')
    .gte('created_at', startDate.toISOString())
    .lte('created_at', endDate.toISOString())
    .eq('status', 'approved')
    .eq('hidden', false)
    .order('created_at', { ascending: false });
  
  // Récupérer les news
  const { data: news } = await supabaseAdmin
    .from('news')
    .select('id, title, excerpt, slug, published_at, created_at')
    .gte('published_at', startDate.toISOString())
    .lte('published_at', endDate.toISOString())
    .eq('status', 'published')
    .eq('hidden', false)
    .order('published_at', { ascending: false });
  
  // Récupérer les wallpapers
  const { data: wallpapers } = await supabaseAdmin
    .from('wallpapers')
    .select('id, title, category, author_name, reddit_username, created_at')
    .gte('created_at', startDate.toISOString())
    .lte('created_at', endDate.toISOString())
    .eq('status', 'published')
    .eq('hidden', false)
    .order('created_at', { ascending: false });
  
  // Calculer le numéro de semaine
  const getWeekNumber = (date: Date): number => {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
  };
  
  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR', { 
      day: 'numeric', 
      month: 'long', 
      year: 'numeric' 
    });
  };
  
  reportData = {
    success: true,
    period: {
      start: startDate.toISOString(),
      end: endDate.toISOString(),
      startFormatted: formatDate(startDate.toISOString()),
      endFormatted: formatDate(endDate.toISOString()),
      weekNumber: getWeekNumber(endDate),
      days,
    },
    stats: {
      resources: resources?.length || 0,
      news: news?.length || 0,
      wallpapers: wallpapers?.length || 0,
    },
    resources: resources || [],
    news: news || [],
    wallpapers: wallpapers || [],
  };
} catch (error) {
  console.error('Error fetching weekly report:', error);
}

// Formater une date pour l'affichage (utilisée dans le template)
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('fr-FR', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
};

// Formater le rapport en markdown (format digest)
const formatReportMarkdown = (data: any) => {
  if (!data || !data.success) return '';
  
  const { period, stats, resources, news, wallpapers } = data;
  
  let markdown = `Week ${period.weekNumber} - ${period.startFormatted} to ${period.endFormatted}\n\n`;
  
  if (resources && resources.length > 0) {
    markdown += `${stats.resources} new resources:\n`;
    resources.forEach((resource: any) => {
      const link = resource.external_link || `https://readme.club/resources/${resource.id}`;
      markdown += `- ${resource.title} (${resource.type}) - ${link}\n`;
    });
    markdown += `\n`;
  }
  
  if (news && news.length > 0) {
    markdown += `${stats.news} news articles:\n`;
    news.forEach((article: any) => {
      const link = `https://readme.club/news/${article.slug}`;
      markdown += `- ${article.title} - ${link}\n`;
    });
    markdown += `\n`;
  }
  
  if (wallpapers && wallpapers.length > 0) {
    markdown += `${stats.wallpapers} new wallpapers:\n`;
    wallpapers.forEach((wallpaper: any) => {
      const link = `https://readme.club/wallpapers/${wallpaper.id}`;
      const title = wallpaper.title || 'Untitled';
      markdown += `- ${title}${wallpaper.category ? ` (${wallpaper.category})` : ''} - ${link}\n`;
    });
    markdown += `\n`;
  }
  
  return markdown;
};
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 dark:text-base-50 font-medium 2xl:text-5xl tracking-tight"
      >
        Newsletter Weekly Report
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 dark:text-base-400 text-balance 2xl:text-xl"
      >
        Generate a weekly digest of new content for your newsletter
      </Text>
    </Wrapper>
  </section>

  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <!-- Period selector -->
      <div class="mb-6 flex items-center gap-4">
        <label for="days-select" class="text-sm font-medium text-base-700 dark:text-base-300">
          Period:
        </label>
        <select
          id="days-select"
          class="px-4 py-2 border border-base-300 dark:border-base-600 rounded-lg bg-base-50 dark:bg-base-100 text-base-900 dark:text-base-50 focus:ring-2 focus:ring-accent-500 focus:border-accent-500 outline-none"
          onchange="window.location.href = `/admin/newsletter-report?days=${this.value}`"
        >
          <option value="7" selected={days === 7}>Last 7 days</option>
          <option value="14" selected={days === 14}>Last 14 days</option>
          <option value="30" selected={days === 30}>Last 30 days</option>
        </select>
      </div>

      {reportData && reportData.success ? (
        <div class="space-y-6">
          <!-- Statistics -->
          <div class="bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 rounded-lg p-6">
            <Text tag="h2" variant="textLG" class="font-semibold text-base-900 dark:text-base-50 mb-4">
              Week {reportData.period.weekNumber} - {reportData.period.startFormatted} to {reportData.period.endFormatted}
            </Text>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="text-center">
                <div class="text-3xl font-bold text-accent-500 dark:text-accent-400">
                  {reportData.stats.resources}
                </div>
                <div class="text-sm text-base-600 dark:text-base-400 mt-1">New Resources</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-accent-500 dark:text-accent-400">
                  {reportData.stats.news}
                </div>
                <div class="text-sm text-base-600 dark:text-base-400 mt-1">News Articles</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-accent-500 dark:text-accent-400">
                  {reportData.stats.wallpapers}
                </div>
                <div class="text-sm text-base-600 dark:text-base-400 mt-1">New Wallpapers</div>
              </div>
            </div>
          </div>

          <!-- Copy button -->
          <div class="flex justify-end">
            <button
              id="copy-report-btn"
              class="px-6 py-2 bg-accent-500 text-base-50 rounded-lg hover:bg-accent-600 transition-colors font-medium"
            >
              Copy Report
            </button>
          </div>

          <!-- Report content -->
          <div class="bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 rounded-lg p-6">
            <pre
              id="report-content"
              class="whitespace-pre-wrap text-sm text-base-700 dark:text-base-300 font-mono overflow-x-auto"
            >
{formatReportMarkdown(reportData)}
            </pre>
          </div>

          <!-- Detailed lists -->
          {reportData.resources && reportData.resources.length > 0 && (
            <div class="bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 rounded-lg p-6">
              <Text tag="h2" variant="textLG" class="font-semibold text-base-900 dark:text-base-50 mb-4">
                {reportData.stats.resources} New Resources
              </Text>
              <ul class="space-y-3">
                {reportData.resources.map((resource: any) => (
                  <li class="border-b border-base-200 dark:border-base-700 pb-3 last:border-0">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <Text tag="h3" variant="textBase" class="font-semibold text-base-900 dark:text-base-50 mb-1">
                          {resource.title}
                        </Text>
                        <Text tag="p" variant="textSM" class="text-base-600 dark:text-base-400 mb-2">
                          {resource.description?.substring(0, 200)}...
                        </Text>
                        <div class="flex items-center gap-2 text-xs text-base-500 dark:text-base-400">
                          <span class="px-2 py-1 bg-base-200 dark:bg-base-700 rounded">{resource.type}</span>
                          <span>{formatDate(resource.created_at)}</span>
                        </div>
                      </div>
                      <a
                        href={resource.external_link || `/resources/${resource.id}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="shrink-0 text-accent-500 dark:text-accent-400 hover:underline text-sm"
                      >
                        View →
                      </a>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {reportData.news && reportData.news.length > 0 && (
            <div class="bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 rounded-lg p-6">
              <Text tag="h2" variant="textLG" class="font-semibold text-base-900 dark:text-base-50 mb-4">
                {reportData.stats.news} News Articles
              </Text>
              <ul class="space-y-3">
                {reportData.news.map((article: any) => (
                  <li class="border-b border-base-200 dark:border-base-700 pb-3 last:border-0">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <Text tag="h3" variant="textBase" class="font-semibold text-base-900 dark:text-base-50 mb-1">
                          {article.title}
                        </Text>
                        {article.excerpt && (
                          <Text tag="p" variant="textSM" class="text-base-600 dark:text-base-400 mb-2">
                            {article.excerpt}
                          </Text>
                        )}
                        <div class="text-xs text-base-500 dark:text-base-400">
                          {formatDate(article.published_at || article.created_at)}
                        </div>
                      </div>
                      <a
                        href={`/news/${article.slug}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="shrink-0 text-accent-500 dark:text-accent-400 hover:underline text-sm"
                      >
                        View →
                      </a>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {reportData.wallpapers && reportData.wallpapers.length > 0 && (
            <div class="bg-base-50 dark:bg-base-100 border border-base-200 dark:border-base-700 rounded-lg p-6">
              <Text tag="h2" variant="textLG" class="font-semibold text-base-900 dark:text-base-50 mb-4">
                {reportData.stats.wallpapers} New Wallpapers
              </Text>
              <ul class="space-y-3">
                {reportData.wallpapers.map((wallpaper: any) => (
                  <li class="border-b border-base-200 dark:border-base-700 pb-3 last:border-0">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <Text tag="h3" variant="textBase" class="font-semibold text-base-900 dark:text-base-50 mb-1">
                          {wallpaper.title || 'Untitled'}
                        </Text>
                        <div class="flex items-center gap-2 text-xs text-base-500 dark:text-base-400 mb-2">
                          {wallpaper.category && (
                            <span class="px-2 py-1 bg-base-200 dark:bg-base-700 rounded">{wallpaper.category}</span>
                          )}
                          {(wallpaper.author_name || wallpaper.reddit_username) && (
                            <span>By {wallpaper.author_name || wallpaper.reddit_username}</span>
                          )}
                        </div>
                        <div class="text-xs text-base-500 dark:text-base-400">
                          {formatDate(wallpaper.created_at)}
                        </div>
                      </div>
                      <a
                        href={`/wallpapers/${wallpaper.id}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="shrink-0 text-accent-500 dark:text-accent-400 hover:underline text-sm"
                      >
                        View →
                      </a>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500 dark:text-base-400">
            {reportData ? 'Error loading report' : 'Loading report...'}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>

<script>
  document.getElementById('copy-report-btn')?.addEventListener('click', () => {
    const reportContent = document.getElementById('report-content');
    if (reportContent) {
      const text = reportContent.textContent || '';
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copy-report-btn');
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          btn.classList.add('bg-green-500');
          setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('bg-green-500');
          }, 2000);
        }
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }
  });
</script>
