---
export const prerender = false; // Page admin dynamique, nécessite SSR

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { checkAdminAuth } from '@/lib/utils/admin';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { useTranslations, getLangFromUrl } from '@/i18n/utils';
import { countries } from '@/lib/utils/countries';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Check admin auth
if (!checkAdminAuth(Astro.cookies)) {
  return Astro.redirect('/admin');
}

const supabaseAdmin = getSupabaseAdmin();

// Fetch analytics
const { data: analytics } = await supabaseAdmin
  .from('analytics')
  .select('*')
  .single();

// Fetch top resources by downloads
const { data: topResources } = await supabaseAdmin
  .from('resources')
  .select('id, title, downloads_count, type, created_at')
  .eq('status', 'approved')
  .eq('hidden', false)
  .order('downloads_count', { ascending: false })
  .limit(50);

// Fetch top wallpapers by downloads
const { data: topWallpapers } = await supabaseAdmin
  .from('wallpapers')
  .select('id, title, download_count, category, created_at')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('download_count', { ascending: false })
  .limit(50);

// Fetch top feature requests by votes
const { data: topFeatures } = await supabaseAdmin
  .from('feature_requests')
  .select('id, title, votes_count, admin_status, created_at')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('votes_count', { ascending: false })
  .limit(50);

// Fetch location stats
const { data: locationStats } = await supabaseAdmin
  .from('location_declarations')
  .select('country_code')
  .order('created_at', { ascending: false });

// Aggregate location stats
const locationAggregated: Array<{ code: string; name: string; count: number }> = [];
if (locationStats) {
  const stats: Record<string, number> = {};
  for (const declaration of locationStats) {
    const code = declaration.country_code.toUpperCase();
    stats[code] = (stats[code] || 0) + 1;
  }
  
  for (const [code, count] of Object.entries(stats)) {
    locationAggregated.push({
      code,
      name: countries[code]?.name || code,
      count,
    });
  }
  locationAggregated.sort((a, b) => b.count - a.count);
}

// Calculate totals
const totalResourceDownloads = topResources?.reduce((sum, r) => sum + (r.downloads_count || 0), 0) || 0;
const totalWallpaperDownloads = topWallpapers?.reduce((sum, w) => sum + (w.download_count || 0), 0) || 0;
const totalGuideDownloads = (analytics?.pdf_v2_downloads || 0) + (analytics?.epub_v2_downloads || 0);
const totalDownloads = totalResourceDownloads + totalWallpaperDownloads + totalGuideDownloads;
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <div class="flex items-center justify-between mb-8">
        <Text
          tag="h1"
          variant="displaySM"
          class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
        >
          Statistics
        </Text>
        <div class="flex items-center gap-4">
          <a href="/admin/resources">
            <Button variant="muted" size="sm">
              Resources
            </Button>
          </a>
          <a href="/admin/features">
            <Button variant="muted" size="sm">
              Features
            </Button>
          </a>
          <a href="/admin/wallpapers">
            <Button variant="muted" size="sm">
              Wallpapers
            </Button>
          </a>
          <a href="/admin/logout">
            <Button variant="muted" size="sm">
              {t('admin.logout')}
            </Button>
          </a>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-base-50 border border-base-200 rounded-lg p-6">
          <Text tag="p" variant="textSM" class="text-base-600 mb-1">
            Total Downloads
          </Text>
          <Text tag="p" variant="displayLG" class="text-base-900 font-bold">
            {totalDownloads.toLocaleString()}
          </Text>
        </div>
        <div class="bg-base-50 border border-base-200 rounded-lg p-6">
          <Text tag="p" variant="textSM" class="text-base-600 mb-1">
            Guide Downloads
          </Text>
          <Text tag="p" variant="displayLG" class="text-base-900 font-bold">
            {totalGuideDownloads.toLocaleString()}
          </Text>
          <Text tag="p" variant="textXS" class="text-base-500 mt-1">
            PDF: {analytics?.pdf_v2_downloads || 0} | EPUB: {analytics?.epub_v2_downloads || 0}
          </Text>
        </div>
        <div class="bg-base-50 border border-base-200 rounded-lg p-6">
          <Text tag="p" variant="textSM" class="text-base-600 mb-1">
            Resource Downloads
          </Text>
          <Text tag="p" variant="displayLG" class="text-base-900 font-bold">
            {totalResourceDownloads.toLocaleString()}
          </Text>
        </div>
        <div class="bg-base-50 border border-base-200 rounded-lg p-6">
          <Text tag="p" variant="textSM" class="text-base-600 mb-1">
            Wallpaper Downloads
          </Text>
          <Text tag="p" variant="displayLG" class="text-base-900 font-bold">
            {totalWallpaperDownloads.toLocaleString()}
          </Text>
        </div>
      </div>

      <!-- Top Resources Table -->
      <div class="mb-8">
        <Text tag="h2" variant="textXL" class="text-base-900 font-semibold mb-4">
          Top Resources by Downloads
        </Text>
        <div class="bg-base-50 border border-base-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full" id="resources-table">
              <thead class="bg-base-100 border-b border-base-200">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="title">
                    Title <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="type">
                    Type <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="downloads">
                    Downloads <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="date">
                    Created <span class="sort-indicator">↕</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-base-200">
                {topResources?.map((resource) => (
                  <tr class="hover:bg-base-100">
                    <td class="px-4 py-3 text-sm text-base-900">
                      <a href={`/resources/${resource.id}`} class="text-accent-600 hover:underline" target="_blank">
                        {resource.title}
                      </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      {resource.type}
                    </td>
                    <td class="px-4 py-3 text-sm text-base-900 font-medium">
                      {resource.downloads_count.toLocaleString()}
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      {new Date(resource.created_at).toLocaleDateString()}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top Wallpapers Table -->
      <div class="mb-8">
        <Text tag="h2" variant="textXL" class="text-base-900 font-semibold mb-4">
          Top Wallpapers by Downloads
        </Text>
        <div class="bg-base-50 border border-base-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full" id="wallpapers-table">
              <thead class="bg-base-100 border-b border-base-200">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="title">
                    Title <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="category">
                    Category <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="downloads">
                    Downloads <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="date">
                    Created <span class="sort-indicator">↕</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-base-200">
                {topWallpapers?.map((wallpaper) => (
                  <tr class="hover:bg-base-100">
                    <td class="px-4 py-3 text-sm text-base-900">
                      <a href={`/wallpapers/${wallpaper.id}`} class="text-accent-600 hover:underline" target="_blank">
                        {wallpaper.title || 'Untitled'}
                      </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      {wallpaper.category || '-'}
                    </td>
                    <td class="px-4 py-3 text-sm text-base-900 font-medium">
                      {wallpaper.download_count.toLocaleString()}
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      {new Date(wallpaper.created_at).toLocaleDateString()}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top Feature Requests Table -->
      <div class="mb-8">
        <Text tag="h2" variant="textXL" class="text-base-900 font-semibold mb-4">
          Top Feature Requests by Votes
        </Text>
        <div class="bg-base-50 border border-base-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full" id="features-table">
              <thead class="bg-base-100 border-b border-base-200">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="title">
                    Title <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="status">
                    Status <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="votes">
                    Votes <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="date">
                    Created <span class="sort-indicator">↕</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-base-200">
                {topFeatures?.map((feature) => (
                  <tr class="hover:bg-base-100">
                    <td class="px-4 py-3 text-sm text-base-900">
                      <a href={`/board#feature-${feature.id}`} class="text-accent-600 hover:underline" target="_blank">
                        {feature.title}
                      </a>
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      <span class={`px-2 py-1 rounded text-xs font-medium ${
                        feature.admin_status === 'completed' ? 'bg-green-100 text-green-800' :
                        feature.admin_status === 'planned' ? 'bg-blue-100 text-blue-800' :
                        feature.admin_status === 'rejected' ? 'bg-red-100 text-red-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {feature.admin_status}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-base-900 font-medium">
                      {feature.votes_count.toLocaleString()}
                    </td>
                    <td class="px-4 py-3 text-sm text-base-600">
                      {new Date(feature.created_at).toLocaleDateString()}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Location Stats Table -->
      <div class="mb-8">
        <Text tag="h2" variant="textXL" class="text-base-900 font-semibold mb-4">
          Users by Country
        </Text>
        <div class="bg-base-50 border border-base-200 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full" id="locations-table">
              <thead class="bg-base-100 border-b border-base-200">
                <tr>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="country">
                    Country <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="users">
                    Users <span class="sort-indicator">↕</span>
                  </th>
                  <th class="px-4 py-3 text-left text-sm font-semibold text-base-900 cursor-pointer hover:bg-base-200" data-sort="percentage">
                    Percentage <span class="sort-indicator">↕</span>
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-base-200">
                {locationAggregated.map((location) => {
                  const totalUsers = locationAggregated.reduce((sum, l) => sum + l.count, 0);
                  const percentage = totalUsers > 0 ? ((location.count / totalUsers) * 100).toFixed(1) : '0';
                  return (
                    <tr class="hover:bg-base-100">
                      <td class="px-4 py-3 text-sm text-base-900">
                        {location.name}
                      </td>
                      <td class="px-4 py-3 text-sm text-base-900 font-medium">
                        {location.count.toLocaleString()}
                      </td>
                      <td class="px-4 py-3 text-sm text-base-600">
                        <div class="flex items-center gap-2">
                          <div class="flex-1 bg-base-200 rounded-full h-2">
                            <div 
                              class="bg-accent-500 h-2 rounded-full" 
                              style={`width: ${percentage}%`}
                            ></div>
                          </div>
                          <span>{percentage}%</span>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </Wrapper>
  </section>
</BaseLayout>

<script>
  // Table sorting functionality
  function initTableSorting(tableId: string) {
    const table = document.getElementById(tableId);
    if (!table) return;

    const headers = table.querySelectorAll('thead th[data-sort]');
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    headers.forEach((header, index) => {
      header.addEventListener('click', () => {
        const sortKey = header.getAttribute('data-sort');
        if (!sortKey) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        const isAscending = header.classList.contains('sort-asc');
        
        // Reset all headers
        headers.forEach(h => {
          h.classList.remove('sort-asc', 'sort-desc');
          const indicator = h.querySelector('.sort-indicator');
          if (indicator) indicator.textContent = '↕';
        });

        // Sort rows
        rows.sort((a, b) => {
          const aCell = a.cells[index];
          const bCell = b.cells[index];
          const aText = aCell.textContent?.trim() || '';
          const bText = bCell.textContent?.trim() || '';

          // Try to parse as number
          const aNum = parseFloat(aText.replace(/,/g, ''));
          const bNum = parseFloat(bText.replace(/,/g, ''));
          
          if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? bNum - aNum : aNum - bNum;
          }

          // Date comparison
          const aDate = new Date(aText);
          const bDate = new Date(bText);
          if (!isNaN(aDate.getTime()) && !isNaN(bDate.getTime())) {
            return isAscending ? bDate.getTime() - aDate.getTime() : aDate.getTime() - bDate.getTime();
          }

          // String comparison
          return isAscending ? bText.localeCompare(aText) : aText.localeCompare(bText);
        });

        // Update DOM
        rows.forEach(row => tbody.appendChild(row));

        // Update header state
        header.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
        const indicator = header.querySelector('.sort-indicator');
        if (indicator) {
          indicator.textContent = isAscending ? '↓' : '↑';
        }
      });
    });
  }

  // Initialize sorting for all tables
  initTableSorting('resources-table');
  initTableSorting('wallpapers-table');
  initTableSorting('features-table');
  initTableSorting('locations-table');
</script>

<style>
  .sort-indicator {
    display: inline-block;
    margin-left: 4px;
    opacity: 0.5;
  }
  th:hover .sort-indicator {
    opacity: 1;
  }
  th.sort-asc .sort-indicator,
  th.sort-desc .sort-indicator {
    opacity: 1;
  }
</style>

