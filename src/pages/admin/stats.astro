---
export const prerender = false;

import AdminLayout from "@/layouts/AdminLayout.astro";
import { checkAdminAuth } from '@/lib/utils/admin';
import { getSupabaseAdmin } from '@/lib/supabase/admin';
import { countries } from '@/lib/utils/countries';

// Check admin auth
if (!checkAdminAuth(Astro.cookies)) {
  return Astro.redirect('/admin');
}

const supabaseAdmin = getSupabaseAdmin();

// Fetch analytics
const { data: analytics } = await supabaseAdmin
  .from('analytics')
  .select('*')
  .single();

// Fetch top resources by downloads
const { data: topResources } = await supabaseAdmin
  .from('resources')
  .select('id, title, downloads_count, type, created_at')
  .eq('status', 'approved')
  .eq('hidden', false)
  .order('downloads_count', { ascending: false })
  .limit(20);

// Fetch top wallpapers by downloads
const { data: topWallpapers } = await supabaseAdmin
  .from('wallpapers')
  .select('id, title, download_count, category, created_at')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('download_count', { ascending: false })
  .limit(20);

// Fetch top feature requests by votes
const { data: topFeatures } = await supabaseAdmin
  .from('feature_requests')
  .select('id, title, votes_count, admin_status, created_at')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('votes_count', { ascending: false })
  .limit(20);

// Fetch location stats
const { data: locationStats } = await supabaseAdmin
  .from('location_declarations')
  .select('country_code')
  .order('created_at', { ascending: false });

// Aggregate location stats
const locationAggregated: Array<{ code: string; name: string; count: number }> = [];
if (locationStats) {
  const stats: Record<string, number> = {};
  for (const declaration of locationStats) {
    const code = declaration.country_code.toUpperCase();
    stats[code] = (stats[code] || 0) + 1;
  }
  
  for (const [code, count] of Object.entries(stats)) {
    locationAggregated.push({
      code,
      name: countries[code]?.name || code,
      count,
    });
  }
  locationAggregated.sort((a, b) => b.count - a.count);
}

// Calculate totals
const totalResourceDownloads = topResources?.reduce((sum, r) => sum + (r.downloads_count || 0), 0) || 0;
const totalWallpaperDownloads = topWallpapers?.reduce((sum, w) => sum + (w.download_count || 0), 0) || 0;
const totalGuideDownloads = (analytics?.pdf_v2_downloads || 0) + (analytics?.epub_v2_downloads || 0);
const totalDownloads = totalResourceDownloads + totalWallpaperDownloads + totalGuideDownloads;
const totalUsers = locationAggregated.reduce((sum, l) => sum + l.count, 0);
---

<AdminLayout title="Statistics" currentPage="stats">
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
    <div class="bg-white border border-base-200 rounded-xl p-6">
      <div class="text-3xl font-bold text-base-900">{totalDownloads.toLocaleString()}</div>
      <div class="text-sm text-base-600 mt-1">Total Downloads</div>
    </div>
    <div class="bg-white border border-base-200 rounded-xl p-6">
      <div class="text-3xl font-bold text-accent-500">{totalGuideDownloads.toLocaleString()}</div>
      <div class="text-sm text-base-600 mt-1">Guide Downloads</div>
      <div class="text-xs text-base-500 mt-1">
        PDF: {analytics?.pdf_v2_downloads || 0} | EPUB: {analytics?.epub_v2_downloads || 0}
      </div>
    </div>
    <div class="bg-white border border-base-200 rounded-xl p-6">
      <div class="text-3xl font-bold text-blue-500">{totalResourceDownloads.toLocaleString()}</div>
      <div class="text-sm text-base-600 mt-1">Resource Downloads</div>
    </div>
    <div class="bg-white border border-base-200 rounded-xl p-6">
      <div class="text-3xl font-bold text-purple-500">{totalWallpaperDownloads.toLocaleString()}</div>
      <div class="text-sm text-base-600 mt-1">Wallpaper Downloads</div>
    </div>
    <div class="bg-white border border-base-200 rounded-xl p-6">
      <div class="text-3xl font-bold text-green-500">{totalUsers.toLocaleString()}</div>
      <div class="text-sm text-base-600 mt-1">Registered Users</div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Top Resources -->
    <div class="bg-white border border-base-200 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-base-200">
        <h2 class="font-semibold text-base-900">Top Resources</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-base-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">#</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">Title</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-base-500">Downloads</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-base-100">
            {topResources?.slice(0, 10).map((r, i) => (
              <tr class="hover:bg-base-50">
                <td class="px-4 py-2 text-sm text-base-500">{i + 1}</td>
                <td class="px-4 py-2">
                  <a href={`/resources/${r.id}`} target="_blank" class="text-sm text-base-900 hover:text-accent-500">
                    {r.title}
                  </a>
                </td>
                <td class="px-4 py-2 text-right text-sm font-medium text-base-900">
                  {r.downloads_count?.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Wallpapers -->
    <div class="bg-white border border-base-200 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-base-200">
        <h2 class="font-semibold text-base-900">Top Wallpapers</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-base-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">#</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">Title</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-base-500">Downloads</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-base-100">
            {topWallpapers?.slice(0, 10).map((w, i) => (
              <tr class="hover:bg-base-50">
                <td class="px-4 py-2 text-sm text-base-500">{i + 1}</td>
                <td class="px-4 py-2">
                  <a href={`/wallpapers/${w.id}`} target="_blank" class="text-sm text-base-900 hover:text-accent-500">
                    {w.title || 'Untitled'}
                  </a>
                </td>
                <td class="px-4 py-2 text-right text-sm font-medium text-base-900">
                  {w.download_count?.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top Features -->
    <div class="bg-white border border-base-200 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-base-200">
        <h2 class="font-semibold text-base-900">Top Feature Requests</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-base-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">#</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">Title</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">Status</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-base-500">Votes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-base-100">
            {topFeatures?.slice(0, 10).map((f, i) => (
              <tr class="hover:bg-base-50">
                <td class="px-4 py-2 text-sm text-base-500">{i + 1}</td>
                <td class="px-4 py-2 text-sm text-base-900">{f.title}</td>
                <td class="px-4 py-2">
                  <span class={`inline-flex px-2 py-0.5 text-xs rounded ${
                    f.admin_status === 'completed' ? 'bg-green-100 text-green-700' :
                    f.admin_status === 'planned' ? 'bg-blue-100 text-blue-700' :
                    f.admin_status === 'rejected' ? 'bg-red-100 text-red-700' :
                    'bg-base-100 text-base-600'
                  }`}>
                    {f.admin_status}
                  </span>
                </td>
                <td class="px-4 py-2 text-right text-sm font-medium text-base-900">
                  {f.votes_count?.toLocaleString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users by Country -->
    <div class="bg-white border border-base-200 rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-base-200">
        <h2 class="font-semibold text-base-900">Users by Country</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-base-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">#</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-base-500">Country</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-base-500">Users</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-base-500">%</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-base-100">
            {locationAggregated.slice(0, 10).map((loc, i) => {
              const pct = totalUsers > 0 ? ((loc.count / totalUsers) * 100).toFixed(1) : '0';
              return (
                <tr class="hover:bg-base-50">
                  <td class="px-4 py-2 text-sm text-base-500">{i + 1}</td>
                  <td class="px-4 py-2 text-sm text-base-900">{loc.name}</td>
                  <td class="px-4 py-2 text-right text-sm font-medium text-base-900">
                    {loc.count.toLocaleString()}
                  </td>
                  <td class="px-4 py-2 text-right text-sm text-base-500">{pct}%</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>
