---
// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import { useTranslations, getLangFromUrl, getLangPrefix, getTranslatedCategory, getTranslatedTip } from '@/i18n/utils';
import tipsData from '../../data/tips.json';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = Astro.site || 'https://readme.club';

// Group tips by category and preserve order
const tipsByCategory: Record<string, typeof tipsData.tips> = {};
const categoryOrder: string[] = [];

tipsData.tips.forEach((tip) => {
  if (!tipsByCategory[tip.category]) {
    tipsByCategory[tip.category] = [];
    categoryOrder.push(tip.category);
  }
  tipsByCategory[tip.category].push(tip);
});

// Use the preserved order instead of sorting alphabetically
const categories = categoryOrder;

// Helper function to create anchor from category name
const getCategoryAnchor = (category: string) => category.toLowerCase().replace(/\s+/g, '-');
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('tips.title')} - ${t('site.name')}`}
      description={t('tips.subtitle')}
      canonical={`${siteUrl}${langPrefix}/tips`}
      lang={lang}
    />
  </Fragment>

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('tips.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('tips.subtitle')}
      </Text>
      <Text
        tag="p"
        variant="textSM"
        class="mt-2 text-base-500"
      >
        {tipsData.metadata.total_tips} {t('tips.total_tips')} â€¢ {t('tips.last_updated')}: {tipsData.metadata.last_updated}
      </Text>
    </Wrapper>
  </section>

  <section>
    <Wrapper variant="standard" class="py-6">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Table of Contents -->
        <aside class="lg:col-span-1">
          <div class="sticky top-24">
            <Text
              tag="h2"
              variant="textSM"
              class="font-semibold text-base-900 mb-4 uppercase tracking-wide"
            >
              {t('tips.table_of_contents') || 'Table of Contents'}
            </Text>
            <nav class="space-y-2">
              {categories.map((category) => (
                <a
                  href={`#${getCategoryAnchor(category)}`}
                  class="block text-sm text-base-600 hover:text-accent-500 transition-colors py-1"
                >
                  {getTranslatedCategory(category, lang)}
                  <span class="text-base-400 ml-2">
                    ({tipsByCategory[category].length})
                  </span>
                </a>
              ))}
            </nav>
          </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:col-span-3">
          <div class="space-y-12">
            {categories.map((category) => (
              <div id={getCategoryAnchor(category)} class="scroll-mt-24">
                <div class="mb-6 pb-4 border-b border-base-200">
                  <Text
                    tag="h2"
                    variant="textLG"
                    class="font-semibold text-base-900"
                  >
                    {getTranslatedCategory(category, lang)}
                  </Text>
                  <Text
                    tag="p"
                    variant="textSM"
                    class="text-base-500 mt-1"
                  >
                    {tipsByCategory[category].length} {t('tips.tips_count')}
                  </Text>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {tipsByCategory[category].map((tip) => (
                    <div class="flex gap-3 items-start p-4 rounded-lg border border-base-200 hover:border-base-300 hover:bg-base-50 transition-all">
                      <div class="flex-shrink-0 mt-0.5">
                        <div class="w-6 h-6 rounded bg-accent-100 flex items-center justify-center">
                          <Text tag="span" variant="textXS" class="font-semibold text-accent-700">
                            {tip.id}
                          </Text>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <Text tag="p" variant="textBase" class="text-base-900 leading-relaxed">
                          {getTranslatedTip(tip.id, lang, tip.tip)}
                        </Text>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </Wrapper>
  </section>

  <section>
    <Wrapper variant="narrow" class="py-12 border-t border-base-200 mt-16">
      <div class="text-center space-y-4">
        <Text tag="h3" variant="textLG" class="font-semibold text-base-900">
          {t('tips.contribute')}
        </Text>
        <Text tag="p" variant="textBase" class="text-base-600">
          {t('tips.contribute_text')}
        </Text>
        <a
          href={`${langPrefix}/submit`}
          class="inline-flex items-center gap-2 justify-center rounded-lg py-3 px-6 text-sm outline-offset-2 transition bg-accent-500 text-white font-medium hover:bg-accent-600"
        >
          {t('tips.submit_tip')}
        </a>
      </div>
    </Wrapper>
  </section>
</BaseLayout>
