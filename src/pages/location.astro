---
export const prerender = true; // Page statique

import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';
import Seo from '@/components/fundations/head/Seo.astro';
import { loadLocationStats, generateLocationMarkers } from '@/lib/utils/location-loader';
import { countries } from '@/lib/utils/countries';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Charger les statistiques depuis JSON statique
const { stats, total, countries: countriesCount, period } = await loadLocationStats();

// Générer les markers pour la carte
const markers = generateLocationMarkers(stats);
---

<BaseLayout>
  <Seo
    title={t('location.title')}
    description={t('location.subtitle')}
    canonical={`${Astro.site}/location`}
    lang={lang}
  />

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('location.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('location.subtitle')}
      </Text>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <div class="space-y-6">
        <!-- Stats Summary -->
        <div class="bg-base-50 rounded-lg p-6 border border-base-200">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <Text tag="h2" variant="textXL" class="font-semibold text-base-900 mb-2">
                {`${total} ${total === 1 ? 'user' : 'users'}`}
              </Text>
              <Text tag="p" variant="textBase" class="text-base-600">
                {`${countriesCount} ${countriesCount === 1 ? 'country' : 'countries'}`}
              </Text>
              <Text tag="p" variant="textSm" class="text-base-500 mt-1">
                Data as of January 1, 2026
              </Text>
              <Text tag="p" variant="textSm" class="text-base-400 mt-1 italic">
                This tool is no longer being updated
              </Text>
            </div>
          </div>
        </div>

        <!-- Map Container -->
        <div id="map" class="w-full h-[600px] rounded-lg border-2 border-base-200"></div>
        
        {markers.length === 0 ? (
          <div class="text-center py-12">
            <Text tag="p" variant="textBase" class="text-base-500">
              {t('location.no_data')}
            </Text>
          </div>
        ) : (
          <!-- Statistics Table (Hidden by default) -->
          <details class="bg-base-50 rounded-lg border border-base-200 overflow-hidden">
            <summary class="p-6 border-b border-base-200 cursor-pointer hover:bg-base-100 transition-colors">
              <div class="flex items-center justify-between">
                <Text tag="h2" variant="textXL" class="font-semibold text-base-900">
                  {t('location.stats_table')}
                </Text>
                <svg class="w-5 h-5 text-base-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </summary>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-base-100">
                  <tr>
                    <th class="px-6 py-3 text-left text-sm font-semibold text-base-900 border-b border-base-200">
                      {t('location.country')}
                    </th>
                    <th class="px-6 py-3 text-right text-sm font-semibold text-base-900 border-b border-base-200">
                      {t('location.users')}
                    </th>
                    <th class="px-6 py-3 text-right text-sm font-semibold text-base-900 border-b border-base-200 w-32">
                      {t('location.percentage')}
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-base-200">
                  {Object.entries(stats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([code, count]) => {
                      const country = countries[code];
                      const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                      return (
                        <tr class="hover:bg-base-50 transition-colors">
                          <td class="px-6 py-4 text-sm text-base-900">
                            <div class="flex items-center gap-3">
                              <span class="font-medium text-base-700">{code}</span>
                              {country && (
                                <span class="text-base-600">{country.name}</span>
                              )}
                            </div>
                          </td>
                          <td class="px-6 py-4 text-sm text-base-900 text-right font-medium">
                            {count}
                          </td>
                          <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                              <div class="flex-1 max-w-[100px] h-2 bg-base-200 rounded-full overflow-hidden">
                                <div 
                                  class="h-full rounded-full transition-all"
                                  style={`width: ${percentage}%; background: linear-gradient(90deg, #283618 0%, #606c38 50%, #dda15e 100%);`}
                                ></div>
                              </div>
                              <span class="text-sm text-base-600 w-12 text-right">{percentage}%</span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                </tbody>
              </table>
            </div>
          </details>
        )}
      </div>
    </Wrapper>
  </section>
</BaseLayout>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  details[open] summary svg {
    transform: rotate(180deg);
  }
</style>
<script>
  // Wait for DOM and Leaflet to be ready
  document.addEventListener('DOMContentLoaded', () => {
    // Load Leaflet dynamically
    const leafletScript = document.createElement('script');
    leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    leafletScript.onload = () => {
      // Load Leaflet.heat plugin after Leaflet is loaded
      const heatScript = document.createElement('script');
      heatScript.src = 'https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js';
      heatScript.onload = () => {
      // Initialize map with bounds to prevent zooming out too far
      const map = L.map('map', {
        minZoom: 2,
        maxBounds: [
          [-90, -180], // Southwest corner
          [90, 180]    // Northeast corner
        ],
        maxBoundsViscosity: 1.0 // Prevent dragging outside bounds
      }).setView([20, 0], 2);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 2,
      }).addTo(map);
      
      // Markers data from server
      const markersData = JSON.parse(document.getElementById('markers-data')?.textContent || '[]');
      
      // Calculate max count for scaling
      const maxCount = Math.max(...markersData.map((m: any) => m.count), 1);
      
      // Prepare heatmap data: [lat, lng, intensity]
      // Intensity is normalized between 0 and 1, with multiple points per country for better coverage
      const heatmapData: number[][] = [];
      const countryMarkers: any[] = [];
      
      markersData.forEach(({ code, count, name, coords }: any) => {
        if (coords && coords.length === 2) {
          const [lat, lng] = coords;
          const intensity = count / maxCount;
          
          // Add multiple points around the country center to create a zone effect
          // More points = larger zone, intensity decreases with distance
          const pointsPerCountry = Math.max(3, Math.ceil(count / 2));
          const spreadRadius = 0.5; // degrees (roughly 50km)
          
          for (let i = 0; i < pointsPerCountry; i++) {
            const angle = (i / pointsPerCountry) * Math.PI * 2;
            const distance = (i / pointsPerCountry) * spreadRadius;
            const offsetLat = lat + (distance * Math.cos(angle));
            const offsetLng = lng + (distance * Math.sin(angle));
            // Intensity decreases with distance from center
            const pointIntensity = intensity * (1 - (i / pointsPerCountry) * 0.5);
            heatmapData.push([offsetLat, offsetLng, pointIntensity]);
          }
          
          // Also add the center point with full intensity
          heatmapData.push([lat, lng, intensity]);
          
          // Store marker info for popups
          countryMarkers.push({ lat, lng, code, count, name });
        }
      });
      
      // Create heatmap layer with zones d'affluence
      if (heatmapData.length > 0) {
        const heatLayer = L.heatLayer(heatmapData, {
          radius: 35, // Larger radius for zone effect
          blur: 25, // Blur for smooth zones
          maxZoom: 10,
          gradient: {
            0.0: '#283618', // black-forest (low)
            0.3: '#606c38', // olive-leaf (medium)
            0.6: '#dda15e', // sunlit-clay (medium-high)
            1.0: '#bc6c25'  // copperwood (high)
          },
          max: 1.0,
          minOpacity: 0.3
        }).addTo(map);
      }
      
      // Add invisible markers for popups (hover/click interaction)
      countryMarkers.forEach(({ lat, lng, code, count, name }) => {
        const marker = L.marker([lat, lng], {
          opacity: 0, // Invisible but clickable
          interactive: true
        }).addTo(map);
        
        marker.bindPopup(`
          <div class="p-2">
            <strong>${name}</strong> (${code})<br>
            ${count} ${count === 1 ? 'user' : 'users'}
          </div>
        `);
        
        // Create a larger invisible circle for easier hover
        const hoverCircle = L.circle([lat, lng], {
          radius: 200000, // ~200km radius
          fillColor: 'transparent',
          fillOpacity: 0,
          color: 'transparent',
          weight: 0,
          interactive: true
        }).addTo(map);
        
        hoverCircle.on('mouseover', () => {
          marker.openPopup();
        });
      });
      
      };
      document.head.appendChild(heatScript);
      };
      document.head.appendChild(leafletScript);
  });
</script>
<script id="markers-data" type="application/json" set:html={JSON.stringify(markers)}></script>
