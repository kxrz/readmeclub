---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import FeatureRequestCard from "@/components/features/FeatureRequestCard.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';
import { supabase } from '@/lib/supabase/client';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const siteUrl = Astro.site || 'https://readme.club';

const url = Astro.url;
const statusFilter = url.searchParams.get('status') || 'all';

// Fetch feature requests
let query = supabase
  .from('feature_requests')
  .select('*')
  .eq('status', 'published')
  .eq('hidden', false)
  .order('votes_count', { ascending: false })
  .order('created_at', { ascending: false });

if (statusFilter !== 'all') {
  query = query.eq('admin_status', statusFilter);
}

const { data: features } = await query;

// Get user's IP hash to check if they've voted (client-side check)
// Note: We'll check votes client-side via API
---

<BaseLayout>
  <Seo
    title={`${t('board.title')} - ${t('site.name')}`}
    description={t('board.subtitle')}
    canonical={`${siteUrl}/board`}
    lang={lang}
  />

  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('board.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {t('board.subtitle')}
      </Text>
      <div class="mt-4">
        <a
          href="#submit-feature-form"
          class="inline-flex items-center gap-1.5 text-sm text-base-500 hover:text-accent-500 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('board.submit')}
        </a>
      </div>
    </Wrapper>
  </section>

  <!-- Filters -->
  <section>
    <Wrapper variant="standard" class="py-6">
      <div class="flex flex-wrap gap-2">
        <a
          href="/board"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            statusFilter === 'all'
              ? 'bg-base-900 text-white'
              : 'bg-base-50 text-base-700 hover:bg-base-100 ring-1 ring-base-200'
          }`}
        >
          {t('board.filter.all')}
        </a>
        <a
          href="/board?status=pending"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            statusFilter === 'pending'
              ? 'bg-base-900 text-white'
              : 'bg-base-50 text-base-700 hover:bg-base-100 ring-1 ring-base-200'
          }`}
        >
          {t('board.filter.pending')}
        </a>
        <a
          href="/board?status=planned"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            statusFilter === 'planned'
              ? 'bg-base-900 text-white'
              : 'bg-base-50 text-base-700 hover:bg-base-100 ring-1 ring-base-200'
          }`}
        >
          {t('board.filter.planned')}
        </a>
        <a
          href="/board?status=completed"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            statusFilter === 'completed'
              ? 'bg-base-900 text-white'
              : 'bg-base-50 text-base-700 hover:bg-base-100 ring-1 ring-base-200'
          }`}
        >
          {t('board.filter.completed')}
        </a>
        <a
          href="/board?status=rejected"
          class={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            statusFilter === 'rejected'
              ? 'bg-base-900 text-white'
              : 'bg-base-50 text-base-700 hover:bg-base-100 ring-1 ring-base-200'
          }`}
        >
          {t('board.filter.rejected')}
        </a>
      </div>
    </Wrapper>
  </section>

  <!-- Feature Requests List -->
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      {features && features.length > 0 ? (
        <div class="space-y-4">
          {features.map((feature) => (
            <FeatureRequestCard feature={feature} />
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('board.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>

  <!-- Submit Form -->
  <section>
    <Wrapper variant="standard" class="py-6 pb-24">
      <div class="max-w-2xl mx-auto">
        <Text tag="h2" variant="textXL" class="font-semibold text-base-900 mb-6">
          {t('board.submit')}
        </Text>
        
        <form
          id="submit-feature-form"
          class="space-y-6 bg-white ring-1 ring-base-200 rounded-lg p-6 scroll-mt-24"
          x-data="{ 
            submitting: false,
            success: false,
            error: null
          }"
          @submit.prevent="
            submitting = true;
            error = null;
            success = false;
            fetch('/api/features', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title: $refs.title.value,
                description: $refs.description.value,
                reddit_username: $refs.reddit_username.value || null,
                tags: $refs.tags.value ? $refs.tags.value.split(',').map(t => t.trim()).filter(t => t) : []
              })
            })
            .then(res => res.json())
            .then(data => {
              submitting = false;
              if (data.success) {
                success = true;
                $refs.title.value = '';
                $refs.description.value = '';
                $refs.reddit_username.value = '';
                $refs.tags.value = '';
                setTimeout(() => window.location.reload(), 1500);
              } else {
                error = data.error || 'Failed to submit';
              }
            })
            .catch(err => {
              submitting = false;
              error = err.message || 'An error occurred';
            })
          "
        >
          <div>
            <label for="title" class="sr-only">{t('board.form.title')}</label>
            <input
              type="text"
              id="title"
              x-ref="title"
              required
              maxlength="80"
              placeholder={t('board.form.title')}
              class="w-full px-4 py-2 text-sm text-base-700 bg-white border border-transparent rounded-lg ring-1 ring-base-200 focus:border-base-300 focus:outline-none focus:ring-base-500 focus:ring-2"
            />
          </div>

          <div>
            <label for="description" class="sr-only">{t('board.form.description')}</label>
            <textarea
              id="description"
              x-ref="description"
              required
              maxlength="500"
              rows="4"
              placeholder={t('board.form.description')}
              class="w-full px-4 py-2 text-sm text-base-700 bg-white border border-transparent rounded-lg ring-1 ring-base-200 focus:border-base-300 focus:outline-none focus:ring-base-500 focus:ring-2"
            ></textarea>
          </div>

          <div>
            <label for="reddit_username" class="sr-only">{t('board.form.reddit_username')}</label>
            <input
              type="text"
              id="reddit_username"
              x-ref="reddit_username"
              maxlength="30"
              placeholder={t('board.form.reddit_username')}
              class="w-full px-4 py-2 text-sm text-base-700 bg-white border border-transparent rounded-lg ring-1 ring-base-200 focus:border-base-300 focus:outline-none focus:ring-base-500 focus:ring-2"
            />
          </div>

          <div>
            <label for="tags" class="sr-only">{t('board.form.tags')}</label>
            <input
              type="text"
              id="tags"
              x-ref="tags"
              placeholder={t('board.form.tags')}
              class="w-full px-4 py-2 text-sm text-base-700 bg-white border border-transparent rounded-lg ring-1 ring-base-200 focus:border-base-300 focus:outline-none focus:ring-base-500 focus:ring-2"
            />
            <Text tag="p" variant="textXS" class="text-base-500 mt-1">
              {t('common.optional')} - {t('board.form.tags')} ({t('board.form.tags_hint')})
            </Text>
          </div>

          <div x-show="error" x-cloak class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <Text tag="p" variant="textSM" class="text-red-700">
              <span x-text="error"></span>
            </Text>
          </div>

          <div x-show="success" x-cloak class="p-6 bg-green-50 border-2 border-green-400 rounded-lg shadow-sm">
            <Text tag="p" variant="textBase" class="text-green-800 font-semibold leading-relaxed">
              <span class="text-green-600 text-xl mr-2">âœ“</span>
              {t('board.form.success')}
            </Text>
          </div>

          <div class="flex justify-end">
            <Button
              type="submit"
              variant="accent"
              size="lg"
              x-bind:disabled="submitting"
            >
              <span x-show="!submitting">{t('board.form.submit')}</span>
              <span x-show="submitting">{t('common.loading') || 'Submitting...'}</span>
            </Button>
          </div>
        </form>
      </div>
    </Wrapper>
  </section>
</BaseLayout>
