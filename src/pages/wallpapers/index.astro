---
// Pré-rendu statique - charge depuis JSON index
export const prerender = true;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import { loadAllWallpapers, filterAndSortWallpapers, paginateWallpapers } from '@/lib/utils/wallpaper-loader';
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);

const url = Astro.url;
const category = url.searchParams.get('category') || null;
const sort = (url.searchParams.get('sort') || 'latest') as 'latest' | 'popular' | 'name' | 'author';
const pageParam = url.searchParams.get('page');
const page = Math.max(1, parseInt(pageParam || '1', 10));
const pageSize = 24;

// Charger tous les wallpapers depuis JSON
const allWallpapers = await loadAllWallpapers();

// Filtrer et trier
const filteredWallpapers = filterAndSortWallpapers(allWallpapers, { category, sort });

// Paginer
const { wallpapers, total, totalPages } = paginateWallpapers(filteredWallpapers, page, pageSize);

// Generate pagination pages array
const paginationPages: number[] = [];
if (totalPages > 1) {
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
      paginationPages.push(i);
    } else if (i === page - 2 || i === page + 2) {
      paginationPages.push(-1); // -1 represents ellipsis
    }
  }
}
const baseSubtitle = t('wallpapers.subtitle');
const normalizedSubtitle = baseSubtitle.length > 0 ? baseSubtitle[0].toLowerCase() + baseSubtitle.slice(1) : baseSubtitle;
const wallpapersSubtitle = total > 0 ? `${total} ${normalizedSubtitle}` : baseSubtitle;

const categories = [
  { value: 'minimalist', label: t('wallpapers.category.minimalist') },
  { value: 'dark', label: t('wallpapers.category.dark') },
  { value: 'light', label: t('wallpapers.category.light') },
  { value: 'pop_culture', label: t('wallpapers.category.pop_culture') },
  { value: 'custom', label: t('wallpapers.category.custom') },
  { value: 'other', label: t('wallpapers.category.other') },
];

const sortOptions = [
  { value: 'latest', label: t('common.sort.latest') },
  { value: 'popular', label: t('common.sort.popular') },
  { value: 'name', label: t('common.sort.name') },
  { value: 'author', label: t('common.sort.author') },
];

// Helper function pour construire l'URL de pagination (retourne seulement la query string)
function buildWallpapersUrl(category: string | null, sort: string, pageNum: number): string {
  const params = new URLSearchParams();
  if (category) params.set('category', category);
  if (sort !== 'latest') params.set('sort', sort);
  if (pageNum > 1) params.set('page', pageNum.toString());
  return params.toString() ? `?${params.toString()}` : '';
}
---

<BaseLayout>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('wallpapers.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {wallpapersSubtitle}
      </Text>
      <div class="mt-4">
        <a
          href={`${langPrefix}/submit-wallpaper`}
          class="inline-flex items-center gap-1.5 text-sm text-base-500 hover:text-accent-500 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('wallpapers.add_new')}
        </a>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6">
      <!-- Filtres et tri temporairement cachés -->
      <!--
      <div class="flex flex-col gap-4 mb-6 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.filter')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            {categories.map((cat) => {
              const params = new URLSearchParams();
              if (sort !== 'latest') params.set('sort', sort);
              params.set('category', cat.value);
              const categoryUrl = `${langPrefix}/wallpapers?${params.toString()}`;
              return (
                <a
                  href={categoryUrl}
                  class={`px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                    category === cat.value
                      ? 'bg-accent-500 text-white'
                      : 'bg-base-100 text-base-700 hover:bg-base-200'
                  }`}
                >
                  {cat.label}
                </a>
              );
            })}
            {category && (
              <a
                href={`${langPrefix}/wallpapers${sort !== 'latest' ? `?sort=${sort}` : ''}`}
                class="px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset filter"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.sort')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            {sortOptions.map((option) => {
              const params = new URLSearchParams();
              if (category) params.set('category', category);
              if (option.value !== 'latest') params.set('sort', option.value);
              const sortUrl = params.toString() ? `${langPrefix}/wallpapers?${params.toString()}` : `${langPrefix}/wallpapers`;
              return (
                <a
                  href={sortUrl}
                  class={`px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                    sort === option.value
                      ? 'bg-accent-500 text-white'
                      : 'bg-base-100 text-base-700 hover:bg-base-200'
                  }`}
                >
                  {option.label}
                </a>
              );
            })}
            {sort !== 'latest' && (
              <a
                href={`${langPrefix}/wallpapers${category ? `?category=${category}` : ''}`}
                class="px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset sort"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
      -->
      
      {wallpapers && wallpapers.length > 0 ? (
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
            {wallpapers.map((wallpaper) => (
              <WallpaperCard wallpaper={wallpaper} />
            ))}
          </div>

          {/* Pagination */}
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 mt-12">
              {page > 1 && (
                <a
                  href={`${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, page - 1)}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.previous')}
                </a>
              )}
              
              <div class="flex items-center gap-1">
                {paginationPages.map((p) => {
                  if (p === -1) {
                    return <span class="px-2 text-base-500">...</span>;
                  }
                  const pageUrl = `${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, p)}`;
                  return (
                    <a
                      href={pageUrl}
                      class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                        p === page
                          ? 'bg-base-900 text-white'
                          : 'text-base-700 bg-white border border-base-200 hover:border-accent-300 hover:text-accent-500'
                      }`}
                    >
                      {p}
                    </a>
                  );
                })}
              </div>

              {page < totalPages && (
                <a
                  href={`${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, page + 1)}`}
                  class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                >
                  {t('common.next')}
                </a>
              )}
            </div>
          )}
        </div>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('wallpapers.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>
