---
// Pré-rendu statique - charge depuis JSON index
export const prerender = true;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Fragment } from "astro/jsx-runtime";
// Fundation
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import NewsletterLink from "@/components/newsletter/NewsletterLink.astro";
import { loadAllWallpapers, filterAndSortWallpapers, paginateWallpapers } from '@/lib/utils/wallpaper-loader';
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';
import { normalizeSiteUrl } from '@/lib/utils/url';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = normalizeSiteUrl(Astro.site);

const url = Astro.url;
const category = url.searchParams.get('category') || null;
const sort = (url.searchParams.get('sort') || 'latest') as 'latest' | 'popular' | 'name' | 'author';
const pageParam = url.searchParams.get('page');
const page = Math.max(1, parseInt(pageParam || '1', 10));
const pageSize = 24;

// Détecter si la page a des paramètres de filtres (à exclure du SEO)
const hasFilters = category !== null || sort !== 'latest' || page > 1;

// Charger tous les wallpapers depuis JSON
const allWallpapers = await loadAllWallpapers();

// Filtrer et trier
const filteredWallpapers = filterAndSortWallpapers(allWallpapers, { category, sort });

// Paginer
const { wallpapers, total, totalPages } = paginateWallpapers(filteredWallpapers, page, pageSize);

// Generate pagination pages array
const paginationPages: number[] = [];
if (totalPages > 1) {
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
      paginationPages.push(i);
    } else if (i === page - 2 || i === page + 2) {
      paginationPages.push(-1); // -1 represents ellipsis
    }
  }
}
const baseSubtitle = t('wallpapers.subtitle');
const normalizedSubtitle = baseSubtitle.length > 0 ? baseSubtitle[0].toLowerCase() + baseSubtitle.slice(1) : baseSubtitle;
const wallpapersSubtitle = total > 0 ? `${total} ${normalizedSubtitle}` : baseSubtitle;

const categories = [
  { value: 'minimalist', label: t('wallpapers.category.minimalist') },
  { value: 'dark', label: t('wallpapers.category.dark') },
  { value: 'light', label: t('wallpapers.category.light') },
  { value: 'pop_culture', label: t('wallpapers.category.pop_culture') },
  { value: 'custom', label: t('wallpapers.category.custom') },
  { value: 'other', label: t('wallpapers.category.other') },
];

const sortOptions = [
  { value: 'latest', label: t('common.sort.latest') },
  { value: 'popular', label: t('common.sort.popular') },
  { value: 'name', label: t('common.sort.name') },
  { value: 'author', label: t('common.sort.author') },
];

// Helper function pour construire l'URL de pagination (retourne seulement la query string)
function buildWallpapersUrl(category: string | null, sort: string, pageNum: number): string {
  const params = new URLSearchParams();
  if (category) params.set('category', category);
  if (sort !== 'latest') params.set('sort', sort);
  if (pageNum > 1) params.set('page', pageNum.toString());
  return params.toString() ? `?${params.toString()}` : '';
}
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('wallpapers.title')} - ${t('site.name')}`}
      description={wallpapersSubtitle}
      canonical={`${siteUrl}${langPrefix}/wallpapers`}
      lang={lang}
      noindex={hasFilters}
    />
    <link rel="alternate" type="application/rss+xml" href={`${siteUrl}/wallpapers/rss.xml`} />
  </Fragment>
  <section>
    <Wrapper variant="hero">
      <Text
        tag="h1"
        variant="displaySM"
        class="text-base-900 font-medium 2xl:text-5xl tracking-tight"
      >
        {t('wallpapers.title')}
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-600 text-balance 2xl:text-xl"
      >
        {wallpapersSubtitle}
      </Text>
      <div class="mt-6 flex flex-wrap gap-3">
        <a
          href={`${langPrefix}/submit-wallpaper`}
          class="inline-flex items-center gap-2 px-4 py-2 bg-accent-500 text-white rounded-full hover:bg-accent-600 transition-colors font-medium text-sm shadow-md hover:shadow-lg focus:ring-2 focus:ring-accent-600 focus:ring-offset-2 focus:outline-none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="shrink-0"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
          {t('wallpapers.add_new')}
        </a>
        <NewsletterLink />
        <a
          href={`${siteUrl}/wallpapers/rss.xml`}
          type="application/rss+xml"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
          aria-label="RSS Feed"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M4 11a9 9 0 0 1 9 9"/>
            <path d="M4 4a16 16 0 0 1 16 16"/>
            <circle cx="5" cy="19" r="1"/>
          </svg>
          RSS Feed
        </a>
      </div>
    </Wrapper>
  </section>
  
  <section>
    <Wrapper variant="standard" class="py-6">
      <!-- Filtres et tri -->
      <div class="flex flex-col gap-4 mb-6 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.filter')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            <a
              href="#"
              data-category="all"
              class={`category-filter px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                !category
                  ? 'bg-accent-500 text-white'
                  : 'bg-base-100 text-base-700 hover:bg-base-200'
              }`}
            >
              All
            </a>
            {categories.map((cat) => (
              <a
                href="#"
                data-category={cat.value}
                class={`category-filter px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                  category === cat.value
                    ? 'bg-accent-500 text-white'
                    : 'bg-base-100 text-base-700 hover:bg-base-200'
                }`}
              >
                {cat.label}
              </a>
            ))}
            {category && (
              <a
                href="#"
                data-category="all"
                class="category-filter px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset filter"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs md:text-sm text-base-500 whitespace-nowrap">{t('common.sort')}</span>
          <div class="flex flex-wrap gap-1.5 md:gap-2">
            {sortOptions.map((option) => (
              <a
                href="#"
                data-sort={option.value}
                class={`sort-option px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors ${
                  sort === option.value
                    ? 'bg-accent-500 text-white'
                    : 'bg-base-100 text-base-700 hover:bg-base-200'
                }`}
              >
                {option.label}
              </a>
            ))}
            {sort !== 'latest' && (
              <a
                href="#"
                data-sort="latest"
                class="sort-option px-2.5 py-1 md:px-3 md:py-1 rounded-full text-xs font-medium transition-colors bg-base-200 text-base-600 hover:bg-base-300 hover:text-base-700"
                title="Reset sort"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
      
      {wallpapers && wallpapers.length > 0 ? (
        <div class="space-y-6">
          {/* Données pour le tri côté client */}
          <script id="wallpapers-data" type="application/json" set:html={JSON.stringify({ wallpapers: allWallpapers, lang: lang || 'en', initialSort: sort, initialCategory: category, initialPage: page })}></script>
          
          <div id="wallpapers-grid" class="grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">
            {wallpapers.map((wallpaper) => (
              <WallpaperCard wallpaper={wallpaper} />
            ))}
          </div>

          {/* Pagination - sera mise à jour par JavaScript */}
          <div id="wallpapers-pagination" class="flex items-center justify-center gap-2 mt-12" data-prev-text={t('common.previous')} data-next-text={t('common.next')}>
            {totalPages > 1 && (
              <>
                {page > 1 && (
                  <a
                    href={`${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, page - 1)}`}
                    class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                  >
                    {t('common.previous')}
                  </a>
                )}
                
                <div class="flex items-center gap-1">
                  {paginationPages.map((p) => {
                    if (p === -1) {
                      return <span class="px-2 text-base-500">...</span>;
                    }
                    const pageUrl = `${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, p)}`;
                    return (
                      <a
                        href={pageUrl}
                        class={`px-4 py-2 text-sm rounded-lg transition-colors ${
                          p === page
                            ? 'bg-base-900 text-white'
                            : 'text-base-700 bg-white border border-base-200 hover:border-accent-300 hover:text-accent-500'
                        }`}
                      >
                        {p}
                      </a>
                    );
                  })}
                </div>

                {page < totalPages && (
                  <a
                    href={`${langPrefix}/wallpapers${buildWallpapersUrl(category, sort, page + 1)}`}
                    class="px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors"
                  >
                    {t('common.next')}
                  </a>
                )}
              </>
            )}
          </div>
          
          <script>
            (function() {
              // Récupérer les données depuis le script JSON
              const dataScript = document.getElementById('wallpapers-data');
              if (!dataScript) return;
              
              const { wallpapers: allWallpapersData, lang: currentLang, initialSort, initialCategory, initialPage } = JSON.parse(dataScript.textContent);
              
              // Fonction de tri
              function sortWallpapers(wallpapers, sortType) {
                const sorted = [...wallpapers];
                switch(sortType) {
                  case 'popular':
                    sorted.sort((a, b) => (b.download_count || 0) - (a.download_count || 0));
                    break;
                  case 'name':
                    sorted.sort((a, b) => {
                      const titleA = (a.title || '').toLowerCase();
                      const titleB = (b.title || '').toLowerCase();
                      return titleA.localeCompare(titleB);
                    });
                    break;
                  case 'author':
                    sorted.sort((a, b) => {
                      const authorA = (a.author_name || a.reddit_username || '').toLowerCase();
                      const authorB = (b.author_name || b.reddit_username || '').toLowerCase();
                      return authorA.localeCompare(authorB);
                    });
                    break;
                  case 'latest':
                  default:
                    sorted.sort((a, b) => {
                      const dateA = new Date(a.created_at).getTime();
                      const dateB = new Date(b.created_at).getTime();
                      return dateB - dateA;
                    });
                    break;
                }
                return sorted;
              }
              
              // Fonction de filtrage
              function filterWallpapers(wallpapers, category) {
                if (!category) return wallpapers;
                return wallpapers.filter(w => w.category === category);
              }
              
              // Fonction de pagination
              function paginateWallpapers(wallpapers, page, pageSize) {
                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                return {
                  data: wallpapers.slice(start, end),
                  total: wallpapers.length,
                  totalPages: Math.ceil(wallpapers.length / pageSize),
                  currentPage: page,
                };
              }
              
              // État actuel
              let currentSort = initialSort || 'latest';
              let currentCategory = initialCategory || null;
              let currentPage = initialPage || 1;
              const pageSize = 24;
              const langPrefix = currentLang === 'en' ? '' : `/${currentLang}`;
              
              // Fonction pour mettre à jour l'affichage
              function updateDisplay() {
                let filtered = filterWallpapers(allWallpapersData, currentCategory);
                let sorted = sortWallpapers(filtered, currentSort);
                let paginated = paginateWallpapers(sorted, currentPage, pageSize);
                
                // Mettre à jour la grille
                const grid = document.getElementById('wallpapers-grid');
                if (grid) {
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = paginated.data.map(w => {
                    const title = (w.title || 'Untitled').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const imageUrl = w.thumbnail_path || `/wallpapers/${w.id}/thumbnail.webp`;
                    const wallpaperUrl = `${langPrefix}/wallpapers/${w.id}`;
                    const downloads = w.download_count || 0;
                    const authorName = w.author_name || (w.reddit_username ? `u/${w.reddit_username}` : '');
                    const categoryBadge = w.category ? `<span class="shrink-0 text-xs uppercase text-base-500 bg-base-100 px-2 py-1 rounded">${w.category}</span>` : '';
                    
                    return `
                      <a href="${wallpaperUrl}" class="group relative flex flex-col rounded-lg border border-base-200 bg-white overflow-hidden hover:border-accent-300 hover:shadow-lg transition-all">
                        <div class="aspect-[3/5] w-full overflow-hidden bg-base-100">
                          <img src="${imageUrl}" alt="${title}" class="h-full w-full object-cover group-hover:scale-105 transition-transform" loading="lazy" />
                        </div>
                        <div class="p-4 flex-1">
                          <div class="flex items-start justify-between gap-2 mb-2">
                            <h3 class="font-semibold text-base-900 line-clamp-2 group-hover:text-accent-500">${title}</h3>
                            ${categoryBadge}
                          </div>
                          <div class="flex items-center justify-between mt-auto">
                            <span class="text-xs text-base-500">${downloads > 0 ? downloads + ' downloads' : ''}</span>
                            ${authorName ? `<span class="text-xs text-base-500">${authorName}</span>` : ''}
                          </div>
                        </div>
                      </a>
                    `;
                  }).join('');
                  
                  grid.innerHTML = tempDiv.innerHTML;
                }
                
                // Mettre à jour la pagination
                updatePagination(paginated);
                
                // Mettre à jour l'URL sans recharger
                const params = new URLSearchParams();
                if (currentCategory) params.set('category', currentCategory);
                if (currentSort !== 'latest') params.set('sort', currentSort);
                if (currentPage > 1) params.set('page', currentPage.toString());
                const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
                window.history.pushState({}, '', newUrl);
              }
              
              // Fonction pour mettre à jour la pagination
              function updatePagination(pagination) {
                const paginationEl = document.getElementById('wallpapers-pagination');
                if (!paginationEl) return;
                
                if (pagination.totalPages <= 1) {
                  paginationEl.style.display = 'none';
                  return;
                }
                
                paginationEl.style.display = 'flex';
                
                const pages = [];
                if (pagination.totalPages <= 7) {
                  for (let i = 1; i <= pagination.totalPages; i++) pages.push(i);
                } else {
                  if (pagination.currentPage <= 3) {
                    for (let i = 1; i <= 4; i++) pages.push(i);
                    pages.push('ellipsis');
                    pages.push(pagination.totalPages);
                  } else if (pagination.currentPage >= pagination.totalPages - 2) {
                    pages.push(1);
                    pages.push('ellipsis');
                    for (let i = pagination.totalPages - 3; i <= pagination.totalPages; i++) pages.push(i);
                  } else {
                    pages.push(1);
                    pages.push('ellipsis');
                    for (let i = pagination.currentPage - 1; i <= pagination.currentPage + 1; i++) pages.push(i);
                    pages.push('ellipsis');
                    pages.push(pagination.totalPages);
                  }
                }
                
                const prevText = paginationEl.getAttribute('data-prev-text') || 'Previous';
                const nextText = paginationEl.getAttribute('data-next-text') || 'Next';
                
                paginationEl.innerHTML = `
                  ${pagination.currentPage > 1 ? `
                    <a href="#" class="page-link px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors" data-page="${pagination.currentPage - 1}">${prevText}</a>
                  ` : ''}
                  <div class="flex items-center gap-1">
                    ${pages.map(p => {
                      if (p === 'ellipsis') return '<span class="px-2 text-base-500">...</span>';
                      return `
                        <a href="#" class="page-link px-4 py-2 text-sm rounded-lg transition-colors ${p === pagination.currentPage ? 'bg-base-900 text-white' : 'text-base-700 bg-white border border-base-200 hover:border-accent-300 hover:text-accent-500'}" data-page="${p}">${p}</a>
                      `;
                    }).join('')}
                  </div>
                  ${pagination.currentPage < pagination.totalPages ? `
                    <a href="#" class="page-link px-4 py-2 text-sm text-base-700 bg-white border border-base-200 rounded-lg hover:border-accent-300 hover:text-accent-500 transition-colors" data-page="${pagination.currentPage + 1}">${nextText}</a>
                  ` : ''}
                `;
                
                paginationEl.querySelectorAll('.page-link').forEach(link => {
                  link.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = parseInt(link.getAttribute('data-page') || '1');
                    updateDisplay();
                  });
                });
              }
              
              // Écouter les clics sur les boutons de tri
              document.querySelectorAll('.sort-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                  e.preventDefault();
                  currentSort = btn.getAttribute('data-sort') || 'latest';
                  currentPage = 1;
                  updateDisplay();
                  
                  document.querySelectorAll('.sort-option').forEach(b => {
                    b.classList.remove('bg-accent-500', 'text-white');
                    b.classList.add('bg-base-100', 'text-base-700');
                  });
                  btn.classList.remove('bg-base-100', 'text-base-700');
                  btn.classList.add('bg-accent-500', 'text-white');
                });
              });
              
              // Écouter les clics sur les filtres de catégorie
              document.querySelectorAll('.category-filter').forEach(btn => {
                btn.addEventListener('click', (e) => {
                  e.preventDefault();
                  const cat = btn.getAttribute('data-category');
                  currentCategory = cat === 'all' ? null : cat;
                  currentPage = 1;
                  updateDisplay();
                  
                  document.querySelectorAll('.category-filter').forEach(b => {
                    b.classList.remove('bg-accent-500', 'text-white');
                    b.classList.add('bg-base-100', 'text-base-700');
                  });
                  btn.classList.remove('bg-base-100', 'text-base-700');
                  btn.classList.add('bg-accent-500', 'text-white');
                });
              });
              
              // Initialiser l'affichage au chargement
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateDisplay);
              } else {
                updateDisplay();
              }
            })();
          </script>
        </div>
      ) : (
        <div class="text-center py-12">
          <Text tag="p" variant="textBase" class="text-base-500">
            {t('wallpapers.no_results')}
          </Text>
        </div>
      )}
    </Wrapper>
  </section>
</BaseLayout>
