---
// Pré-rendu statique pour réduire drastiquement les requêtes DB
export const prerender = true;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
// Components
import Hero from "@/components/landing/Hero.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import ResourceCard from "@/components/resources/ResourceCard.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import SmallResourceCard from "@/components/resources/SmallResourceCard.astro";
import SmallMoreCard from "@/components/resources/SmallMoreCard.astro";
import LatestResourceCard from "@/components/resources/LatestResourceCard.astro";
import LatestMoreCard from "@/components/resources/LatestMoreCard.astro";
import MoreCard from "@/components/common/MoreCard.astro";
import BuyMeACoffee from "@/components/common/BuyMeACoffee.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';
import { loadAllWallpapers } from '@/lib/utils/wallpaper-loader';
import { loadAllResources, filterAndSortResources } from '@/lib/utils/resource-loader';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);

// Charger les resources depuis JSON statique
const allResources = await loadAllResources();

// Latest resources pour activity feed
const latestResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
}).slice(0, 5);

// Featured resources (most downloaded)
const featuredResources = filterAndSortResources(allResources, {
  sortBy: 'downloads_count',
  sortOrder: 'desc',
})
  .filter(r => (r.downloads_count || 0) > 0)
  .slice(0, 8);

// Starred resources
const starredResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
})
  .filter(r => r.starred === true)
  .slice(0, 6);

// Charger les wallpapers depuis les fichiers statiques
const allWallpapers = await loadAllWallpapers();
const latestWallpapers = allWallpapers
  .filter(w => !w.hidden)
  .sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
    return dateB - dateA;
  })
  .slice(0, 4);

// News retirées - maintenant affichées uniquement sur /news
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('site.name')} - ${t('site.tagline')}`}
      description={t('site.description')}
      lang={lang}
    />
  </Fragment>
  <Hero />
  
  {latestResources && latestResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-12">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.latest_additions')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {latestResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`${lang === 'en' ? '' : `/${lang}`}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}
  
  {featuredResources && featuredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.most_downloaded')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {featuredResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`${lang === 'en' ? '' : `/${lang}`}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}


  {starredResources && starredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.starred_resources')}
          </Text>
        </div>
        <div class="grid grid-cols-1 gap-2 mt-6">
          {starredResources.map((resource) => (
            <SmallResourceCard resource={resource} />
          ))}
          <SmallMoreCard href={`${langPrefix}/resources`} label={t('common.view') + ' all'} />
        </div>
      </Wrapper>
    </section>
  )}

  {latestWallpapers && latestWallpapers.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('wallpapers.title')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/wallpapers`}
            aria-label={t('nav.wallpapers')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-3 xl:grid-cols-4 mt-8">
          {latestWallpapers.map((wallpaper) => (
            <WallpaperCard wallpaper={wallpaper} />
          ))}
          <MoreCard href={`${langPrefix}/wallpapers`} label={t('common.view') + ' all'} variant="wallpaper" />
        </div>
      </Wrapper>
    </section>
  )}

  
  <section>
    <Wrapper variant="standard" class="pt-6 pb-24">
      <div class="border-t border-base-200 pt-8 pb-4 flex items-center justify-center">
        <BuyMeACoffee variant="default" />
      </div>
      <div class="border-t border-base-200 pt-2 mt-8">
        <Text
          tag="h2"
          variant="textXS"
          class="font-medium uppercase text-base-600"
        >
          {t('disclaimer.title')}
        </Text>
        <Text
          tag="p"
          variant="textSM"
          class="mt-4 text-base-600"
        >
          {t('disclaimer.content')}
        </Text>
      </div>
    </Wrapper>
  </section>
</BaseLayout>
