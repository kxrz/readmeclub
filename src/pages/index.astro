---
// Pré-rendu statique pour réduire drastiquement les requêtes DB
export const prerender = true;

// Layout
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Fragment } from "astro/jsx-runtime";
// Components
import Hero from "@/components/landing/Hero.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import ResourceCard from "@/components/resources/ResourceCard.astro";
import WallpaperCard from "@/components/wallpapers/WallpaperCard.astro";
import SmallResourceCard from "@/components/resources/SmallResourceCard.astro";
import SmallMoreCard from "@/components/resources/SmallMoreCard.astro";
import LatestResourceCard from "@/components/resources/LatestResourceCard.astro";
import LatestMoreCard from "@/components/resources/LatestMoreCard.astro";
import GuideCard from "@/components/resources/GuideCard.astro";
import TipsCard from "@/components/resources/TipsCard.astro";
import MoreCard from "@/components/common/MoreCard.astro";
import BuyMeACoffee from "@/components/common/BuyMeACoffee.astro";
import Seo from "@/components/fundations/head/Seo.astro";
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';
import { loadAllWallpapers } from '@/lib/utils/wallpaper-loader';
import { loadAllResources, filterAndSortResources } from '@/lib/utils/resource-loader';
import { loadAllNewsArticles } from '@/lib/utils/news-loader';
import NewsCardSmall from "@/components/news/NewsCardSmall.astro";
import NewsletterCTA from "@/components/newsletter/NewsletterCTA.astro";
import Link from "@/components/fundations/components/Link.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);
const siteUrl = Astro.site || 'https://readme.club';

// Charger les resources depuis JSON statique
const allResources = await loadAllResources();

// Latest resources pour activity feed
const latestResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
}).slice(0, 5);

// Featured resources (most downloaded)
const featuredResources = filterAndSortResources(allResources, {
  sortBy: 'downloads_count',
  sortOrder: 'desc',
})
  .filter(r => (r.downloads_count || 0) > 0)
  .slice(0, 8);

// Starred resources
const starredResources = filterAndSortResources(allResources, {
  sortBy: 'created_at',
  sortOrder: 'desc',
})
  .filter(r => r.starred === true)
  .slice(0, 6);

// Charger les wallpapers depuis les fichiers statiques
const allWallpapers = await loadAllWallpapers();
const latestWallpapers = allWallpapers
  .filter(w => !w.hidden)
  .sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
    const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
    return dateB - dateA;
  })
  .slice(0, 4);

// Charger les dernières news
const allNews = await loadAllNewsArticles();
const latestNews = allNews.slice(0, 3);
---

<BaseLayout>
  <Fragment slot="head">
    <Seo
      title={`${t('site.name')} - ${t('site.tagline')}`}
      description={t('site.description')}
      canonical={`${siteUrl}${langPrefix || '/'}`}
      lang={lang}
    />
  </Fragment>
  <Hero />
  
  {/* Section Guide & Tips */}
  <section>
    <Wrapper variant="standard" class="pt-6 pb-12">
      <div class="pt-2">
        <div class="bg-gradient-to-br from-accent-50 to-base-50 rounded-xl border border-accent-200 p-6 md:p-8">
          <Text
            tag="h2"
            variant="textLG"
            class="font-semibold text-base-900 mb-3"
          >
            {t('homepage.new_user.title')}
          </Text>
          <Text
            tag="p"
            variant="textBase"
            class="text-base-700 mb-6 leading-relaxed"
          >
            {t('homepage.new_user.description')}
          </Text>
          <div class="flex flex-col gap-3">
            <a
              href={`${langPrefix}/start`}
              class="relative inline-flex items-center justify-center gap-2 px-4 py-2.5 pb-3 bg-gradient-to-r from-accent-500 to-accent-600 text-base-50 rounded-lg hover:from-accent-600 hover:to-accent-700 transition-all font-semibold text-sm transform hover:scale-105 w-fit animate-pulse-glow overflow-hidden"
            >
              <div class="absolute inset-0 rounded-lg bg-gradient-to-r from-white/0 via-white/30 to-white/0 opacity-0 hover:opacity-100 transition-opacity duration-700 shimmer-effect"></div>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="relative z-10"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                <path d="M12 17h.01"></path>
              </svg>
              <span class="relative z-10">Start your adventure here</span>
            </a>
            <div class="flex flex-wrap gap-3">
              <a
                href={`${langPrefix}/guide`}
                class="inline-flex items-center gap-2 px-4 py-2 bg-accent-500 text-base-50 rounded-lg hover:bg-accent-600 transition-colors font-medium text-sm"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                  <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                  <path d="M9 9l1 0"></path>
                  <path d="M9 13l6 0"></path>
                  <path d="M9 17l6 0"></path>
                </svg>
                {t('guide.title')}
              </a>
              <a
                href={`${langPrefix}/tips`}
                class="inline-flex items-center gap-2 px-4 py-2 bg-base-700 text-base-50 rounded-lg hover:bg-base-800 transition-colors font-medium text-sm"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <path d="M12 2l3.09 6.26l6.91 1.01l-5 4.87l1.18 6.88l-6.18 -3.25l-6.18 3.25l1.18 -6.88l-5 -4.87l6.91 -1.01z"></path>
                </svg>
                {t('tips.title')}
              </a>
              <Link
                href={`${langPrefix}/newsletter`}
                class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-base-800 to-base-900 text-base-50 rounded-lg hover:from-base-900 hover:to-base-950 transition-all font-medium text-sm shadow-md hover:shadow-lg transform hover:scale-105"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect width="20" height="16" x="2" y="4" rx="2"/>
                  <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                </svg>
                Subscribe to newsletter
              </Link>
            </div>
          </div>
        </div>
      </div>
    </Wrapper>
  </section>
  
  {latestResources && latestResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-12">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.latest_additions')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {latestResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`${lang === 'en' ? '' : `/${lang}`}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}
  
  {featuredResources && featuredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.most_downloaded')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/resources`}
            aria-label={t('nav.resources')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="mt-8">
          <div class="scrollable-content relative flex snap-x snap-mandatory gap-4 py-2 px-2 overflow-x-auto scrollbar-hide items-stretch">
            {featuredResources.map((resource) => (
              <div class="flex-shrink-0 w-[280px] snap-start flex">
                <LatestResourceCard resource={resource} />
              </div>
            ))}
            <div class="flex-shrink-0 w-[280px] snap-start flex">
              <LatestMoreCard href={`${lang === 'en' ? '' : `/${lang}`}/resources`} />
            </div>
          </div>
        </div>
      </Wrapper>
    </section>
  )}


  {starredResources && starredResources.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('resources.starred_resources')}
          </Text>
        </div>
        <div class="grid grid-cols-1 gap-2 mt-6">
          {starredResources.map((resource) => (
            <SmallResourceCard resource={resource} />
          ))}
          <SmallMoreCard href={`${langPrefix}/resources`} label={t('common.view') + ' all'} />
        </div>
      </Wrapper>
    </section>
  )}

  {latestWallpapers && latestWallpapers.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('wallpapers.title')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/wallpapers`}
            aria-label={t('nav.wallpapers')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="grid grid-cols-3 gap-3 md:grid-cols-4 xl:grid-cols-6 mt-8">
          {latestWallpapers.map((wallpaper) => (
            <WallpaperCard wallpaper={wallpaper} />
          ))}
          <MoreCard href={`${langPrefix}/wallpapers`} label={t('common.view') + ' all'} variant="wallpaper" />
        </div>
      </Wrapper>
    </section>
  )}

  {/* Latest News */}
  {latestNews && latestNews.length > 0 && (
    <section>
      <Wrapper variant="standard" class="pt-6 pb-24">
        <div class="flex flex-col gap-4 lg:flex-row lg:justify-between border-t border-base-200 pt-2">
          <Text
            tag="h2"
            variant="textXS"
            class="font-medium uppercase text-base-600"
          >
            {t('news.latest')}
          </Text>
          <Text
            tag="a"
            variant="textXS"
            href={`${lang === 'en' ? '' : `/${lang}`}/news`}
            aria-label={t('nav.news')}
            class="text-base-600 uppercase hover:text-accent-500 flex items-center gap-1 transition-all duration-200"
          >
            {t('common.view')} all
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-narrow-right"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M5 12l14 0"></path>
              <path d="M15 16l4 -4"></path>
              <path d="M15 8l4 4"></path>
            </svg>
          </Text>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-6">
          {latestNews.map((article) => (
            <NewsCardSmall news={article} />
          ))}
        </div>
      </Wrapper>
    </section>
  )}
  
  <section>
    <Wrapper variant="standard" class="pt-6 pb-24">
      <div class="border-t border-base-200 pt-8 pb-4 flex items-center justify-center">
        <BuyMeACoffee variant="default" />
      </div>
      <div class="border-t border-base-200 pt-2 mt-8">
        <Text
          tag="h2"
          variant="textXS"
          class="font-medium uppercase text-base-600"
        >
          {t('disclaimer.title')}
        </Text>
        <Text
          tag="p"
          variant="textSM"
          class="mt-4 text-base-600"
        >
          {t('disclaimer.content')}
        </Text>
      </div>
    </Wrapper>
  </section>
</BaseLayout>

<style>
  :root {
    /* Graphite halo */
    --pulse-glow-rgb: 55 65 81; /* ~ slate/graphite */
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 10px 25px -5px rgb(var(--pulse-glow-rgb) / 0.28), 0 0 0 0 rgb(var(--pulse-glow-rgb) / 0.35);
    }
    50% {
      box-shadow: 0 10px 25px -5px rgb(var(--pulse-glow-rgb) / 0.45), 0 0 20px 5px rgb(var(--pulse-glow-rgb) / 0.28);
    }
  }
  
  @keyframes shimmer {
    0% {
      transform: translateX(-100%) skewX(-15deg);
    }
    100% {
      transform: translateX(200%) skewX(-15deg);
    }
  }
  
  .animate-pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
  }
  
  .shimmer-effect {
    animation: shimmer 3s infinite;
  }
  
  .animate-pulse-glow:hover {
    animation: pulse-glow 1s ease-in-out infinite;
  }
</style>
