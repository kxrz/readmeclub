---
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import type { FeatureRequest } from '@/lib/supabase/schema';
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';

interface Props {
  feature: FeatureRequest;
  hasVoted?: boolean;
}

const { feature, hasVoted = false } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const langPrefix = getLangPrefix(lang);

const statusColors: Record<string, string> = {
  pending: 'bg-yellow-100 text-yellow-700',
  planned: 'bg-blue-100 text-blue-700',
  completed: 'bg-green-100 text-green-700',
  rejected: 'bg-red-100 text-red-700',
};
---

<div class="bg-white rounded-lg border border-base-200 p-6 hover:border-accent-300 hover:shadow-lg transition-all">
  <div class="flex items-start justify-between gap-4 mb-4">
    <div class="flex-1">
      <Text tag="h3" variant="textLG" class="font-semibold text-base-900 mb-2">
        {feature.title}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-3">
        {feature.description}
      </Text>
    </div>
    <span class={`shrink-0 text-xs uppercase px-3 py-1 rounded font-medium ${statusColors[feature.admin_status] || statusColors.pending}`}>
      {t(`board.status.${feature.admin_status}`)}
    </span>
  </div>
  
  {feature.tags && feature.tags.length > 0 && (
    <div class="flex flex-wrap gap-2 mb-4">
      {feature.tags.map((tag) => (
        <span class="text-xs text-base-500 bg-base-50 px-2 py-1 rounded">
          {tag}
        </span>
      ))}
    </div>
  )}
  
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1z"></path>
          <path d="M11 9h5a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-5l-4 -7v-5a2 2 0 0 1 2 -2h3a2 2 0 0 1 2 2z"></path>
        </svg>
        <Text tag="span" variant="textSM" class="text-base-700 font-medium" data-votes-count>
          {t('board.votes', { count: feature.votes_count })}
        </Text>
      </div>
      {feature.reddit_username && (
        <Text tag="span" variant="textXS" class="text-base-500">
          @{feature.reddit_username}
        </Text>
      )}
    </div>
    <button
      data-feature-id={feature.id}
      data-has-voted={hasVoted}
      class={`vote-button px-4 py-2 text-sm rounded-lg transition-colors flex items-center gap-2 ${
        hasVoted 
          ? 'bg-accent-100 text-accent-700 cursor-not-allowed' 
          : 'bg-accent-500 text-white hover:bg-accent-600'
      }`}
      disabled={hasVoted}
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1z"></path>
        <path d="M11 9h5a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-5l-4 -7v-5a2 2 0 0 1 2 -2h3a2 2 0 0 1 2 2z"></path>
      </svg>
      {hasVoted ? t('board.voted') || 'Voted' : t('board.vote')}
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const voteButtons = document.querySelectorAll('.vote-button');
    
    voteButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const featureId = button.getAttribute('data-feature-id');
        const hasVoted = button.getAttribute('data-has-voted') === 'true';
        
        if (hasVoted) return;
        
        try {
          const response = await fetch(`/api/features/${featureId}/vote`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          
          const data = await response.json();
          
          if (response.ok) {
            // Update button state
            button.setAttribute('data-has-voted', 'true');
            button.disabled = true;
            button.classList.remove('bg-accent-500', 'text-white', 'hover:bg-accent-600');
            button.classList.add('bg-accent-100', 'text-accent-700', 'cursor-not-allowed');
            button.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-thumb-up">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M7 11v8a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1v-7a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1z"></path>
                <path d="M11 9h5a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-5l-4 -7v-5a2 2 0 0 1 2 -2h3a2 2 0 0 1 2 2z"></path>
              </svg>
              ${button.textContent.includes('Voted') ? button.textContent : 'Voted'}
            `;
            
            // Update votes count
            const votesElement = button.closest('.bg-white')?.querySelector('[data-votes-count]');
            if (votesElement && data.votes_count !== undefined) {
              votesElement.textContent = `${data.votes_count} ${data.votes_count === 1 ? 'vote' : 'votes'}`;
            }
            
            // Reload page to show updated vote count
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alert(data.error || 'Failed to vote');
          }
        } catch (error) {
          console.error('Error voting:', error);
          alert('An error occurred while voting');
        }
      });
    });
  });
</script>

