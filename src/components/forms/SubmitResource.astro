---
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<form
  id="submit-resource-form"
  class="relative w-full max-w-2xl mx-auto space-y-8 bg-base-50 ring-1 ring-base-200 rounded-2xl p-8 lg:p-12"
  x-data="{ 
    uploading: false, 
    fileUrl: null,
    resourceType: 'tool',
    hasFile: false,
    hasExternalLink: false,
    error: null,
    success: false,
    successMessage: ''
  }"
  @submit.prevent="uploading = true; error = null; success = false"
>
  <!-- Basic Information -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.basic_info')}
      </Text>
    </div>

    <div>
      <label for="type" class="sr-only">{t('resources.type.label')}</label>
      <select
        id="type"
        name="type"
        x-model="resourceType"
        required
        class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
      >
        <option value="tool">{t('resources.type.tool')}</option>
        <option value="language_file">{t('resources.type.language_file')}</option>
        <option value="plugin">{t('resources.type.plugin')}</option>
        <option value="documentation">{t('resources.type.documentation')}</option>
        <option value="link">{t('resources.type.link')}</option>
        <option value="other">{t('resources.type.other')}</option>
      </select>
    </div>

    <div>
      <label for="title" class="sr-only">{t('form.title')}</label>
      <input
        type="text"
        id="title"
        name="title"
        required
        maxlength="255"
        placeholder={t('form.title_placeholder')}
        class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
      />
    </div>

    <div>
      <label for="description" class="sr-only">{t('form.description')}</label>
      <textarea
        id="description"
        name="description"
        required
        rows="4"
        placeholder={t('form.description_placeholder')}
        class="block w-full px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2 resize-none"
      ></textarea>
    </div>
  </div>

  <!-- File or Link -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.resource_content')}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-4">
        {t('form.resource_content_help')}
      </Text>
    </div>

    <div class="space-y-4">
      <div class="flex items-start gap-3 p-4 rounded-lg ring-1 ring-base-200 hover:ring-base-300 transition-colors">
        <input
          type="checkbox"
          id="hasFile"
          x-model="hasFile"
          @change="hasExternalLink = false"
          class="mt-1 rounded border-base-300 text-accent-500 focus:ring-accent-500"
        />
        <div class="flex-1">
          <label for="hasFile" class="block text-sm font-medium text-base-900 cursor-pointer">
            {t('form.file')}
          </label>
          <Text tag="p" variant="textXS" class="text-base-500 mt-1">
            {t('form.file_help')}
          </Text>
          <input
            type="file"
            id="file"
            name="file"
            x-show="hasFile"
            x-transition
            class="mt-3 w-full text-sm text-base-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-base-100 file:text-base-700 hover:file:bg-base-200 cursor-pointer"
            style="display: none;"
          />
        </div>
      </div>

      <div class="flex items-start gap-3 p-4 rounded-lg ring-1 ring-base-200 hover:ring-base-300 transition-colors">
        <input
          type="checkbox"
          id="hasExternalLink"
          x-model="hasExternalLink"
          @change="hasFile = false"
          class="mt-1 rounded border-base-300 text-accent-500 focus:ring-accent-500"
        />
        <div class="flex-1">
          <label for="hasExternalLink" class="block text-sm font-medium text-base-900 cursor-pointer">
            {t('form.external_link')}
          </label>
          <Text tag="p" variant="textXS" class="text-base-500 mt-1">
            {t('form.external_link_help')}
          </Text>
          <input
            type="url"
            id="external_link"
            name="external_link"
            x-show="hasExternalLink"
            x-transition
            placeholder="https://example.com/resource"
            class="mt-3 block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
            style="display: none;"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Visual -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.visual')}
      </Text>
    </div>

    <div>
      <label for="thumbnail_url" class="sr-only">{t('form.thumbnail')}</label>
      <input
        type="url"
        id="thumbnail_url"
        name="thumbnail_url"
        placeholder={t('form.thumbnail_placeholder')}
        class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
      />
      <Text tag="p" variant="textXS" class="text-base-500 mt-2">
        {t('form.thumbnail_help')}
      </Text>
    </div>
  </div>

  <!-- Additional Details -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.additional_details')}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-4">
        {t('form.additional_details_help')}
      </Text>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="version" class="sr-only">{t('resources.version')}</label>
        <input
          type="text"
          id="version"
          name="version"
          maxlength="50"
          placeholder={t('form.version_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>

      <div>
        <label for="compatibility" class="sr-only">{t('resources.compatibility')}</label>
        <input
          type="text"
          id="compatibility"
          name="compatibility"
          maxlength="255"
          placeholder={t('form.compatibility_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>
    </div>


    <div>
      <label for="installation_instructions" class="sr-only">{t('resources.installation')}</label>
      <textarea
        id="installation_instructions"
        name="installation_instructions"
        rows="3"
        placeholder={t('form.installation_placeholder')}
        class="block w-full px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2 resize-none"
      ></textarea>
    </div>

    <div>
      <label for="known_issues" class="sr-only">{t('resources.known_issues')}</label>
      <textarea
        id="known_issues"
        name="known_issues"
        rows="2"
        placeholder={t('form.known_issues_placeholder')}
        class="block w-full px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2 resize-none"
      ></textarea>
    </div>
  </div>

  <!-- Contributor Information -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.contributor_info')}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-4">
        {t('form.contributor_info_help')}
      </Text>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="contributor_name" class="sr-only">{t('form.contributor_name')}</label>
        <input
          type="text"
          id="contributor_name"
          name="contributor_name"
          maxlength="255"
          placeholder={t('form.contributor_name_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>

      <div>
        <label for="contact_info" class="sr-only">{t('form.contact_info')}</label>
        <input
          type="text"
          id="contact_info"
          name="contact_info"
          maxlength="255"
          placeholder={t('form.contact_info_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-base-50 border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div x-show="error" x-transition class="p-4 bg-red-50 border border-red-200 rounded-lg">
    <Text tag="p" variant="textSM" class="text-red-700">
      <span x-text="error"></span>
    </Text>
  </div>

  <!-- Success Message -->
  <div x-show="success" x-transition class="p-6 bg-green-50 border-2 border-green-400 rounded-lg shadow-sm">
    <Text tag="p" variant="textBase" class="text-green-800 font-semibold leading-relaxed">
      <span class="text-green-600 text-xl mr-2">âœ“</span>
      <span x-text="successMessage || '{t(\'form.success_message\')}'"></span>
    </Text>
  </div>

  <!-- Submit Button -->
  <div class="pt-4">
    <Button
      type="submit"
      variant="accent"
      size="lg"
      class="w-full justify-center"
      x-bind:disabled="uploading"
    >
      <span x-show="!uploading">{t('form.submit')}</span>
      <span x-show="uploading">{t('form.uploading')}</span>
    </Button>
  </div>
</form>

<script>
  document.getElementById('submit-resource-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const alpineData = (window as any).Alpine?.$data(form);
    
    if (alpineData) {
      alpineData.uploading = true;
      alpineData.error = null;
      alpineData.success = false;
    }

    const formData = new FormData(form);
    const data: Record<string, any> = {};
    
    // Collect form data
    for (const [key, value] of formData.entries()) {
      if (key === 'file') {
        // Skip file, handled separately
        continue;
      } else if (value) {
        data[key] = value;
      }
    }
    
    // Validate that either file or external_link is provided
    const fileInput = form.querySelector('#file') as HTMLInputElement;
    const hasFile = fileInput?.files?.[0];
    const hasExternalLink = data.external_link;
    
    if (!hasFile && !hasExternalLink) {
      if (alpineData) {
        alpineData.error = 'Please provide either a file or an external link.';
        alpineData.uploading = false;
      } else {
        alert('Please provide either a file or an external link.');
      }
      return;
    }
    
    // Validate file format if file is provided
    if (hasFile) {
      const allowedTypes = [
        'application/zip',
        'application/x-zip-compressed',
        'application/x-rar-compressed',
        'application/x-7z-compressed',
        'application/pdf',
        'application/epub+zip',
        'application/x-epub+zip',
        'text/plain',
        'text/html',
        'application/javascript',
        'text/css',
        'application/json',
        'image/png',
        'image/jpeg',
        'image/jpg',
        'image/gif',
        'image/webp',
        'image/svg+xml',
        'application/x-font-ttf',
        'application/x-font-truetype',
        'font/ttf',
        'font/otf',
        'application/vnd.ms-fontobject',
        'font/woff',
        'font/woff2',
      ];
      
      const fileType = hasFile.type;
      const fileName = hasFile.name.toLowerCase();
      const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1);
      const allowedExtensions = ['zip', 'rar', '7z', 'pdf', 'epub', 'txt', 'html', 'htm', 'js', 'css', 'json', 'png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'ttf', 'otf', 'eot', 'woff', 'woff2', 'bin'];
      
      const isValidType = fileType && allowedTypes.includes(fileType);
      const isValidExtension = allowedExtensions.includes(fileExtension);
      
      if (!isValidType && !isValidExtension) {
        if (alpineData) {
          alpineData.error = `File type not allowed. Allowed formats: ${allowedExtensions.join(', ')}`;
          alpineData.uploading = false;
        } else {
          alert(`File type not allowed. Allowed formats: ${allowedExtensions.join(', ')}`);
        }
        return;
      }
    }
    
    // Validate URL format if external_link is provided
    if (hasExternalLink) {
      try {
        const url = new URL(hasExternalLink);
        // Check for valid protocols
        if (!['http:', 'https:'].includes(url.protocol)) {
          throw new Error('Invalid protocol');
        }
      } catch (error) {
        if (alpineData) {
          alpineData.error = 'Please provide a valid URL (must start with http:// or https://)';
          alpineData.uploading = false;
        } else {
          alert('Please provide a valid URL (must start with http:// or https://)');
        }
        return;
      }
    }
    
    // Validate thumbnail_url if provided
    if (data.thumbnail_url) {
      try {
        const url = new URL(data.thumbnail_url);
        if (!['http:', 'https:'].includes(url.protocol)) {
          throw new Error('Invalid protocol');
        }
      } catch (error) {
        if (alpineData) {
          alpineData.error = 'Please provide a valid thumbnail URL (must start with http:// or https://)';
          alpineData.uploading = false;
        } else {
          alert('Please provide a valid thumbnail URL (must start with http:// or https://)');
        }
        return;
      }
    }
    
    // Handle file upload
    if (hasFile) {
      const uploadFormData = new FormData();
      uploadFormData.append('file', fileInput.files[0]);
      
      try {
        const uploadRes = await fetch('/api/resources/upload', {
          method: 'POST',
          body: uploadFormData,
        });
        
        if (!uploadRes.ok) {
          const errorData = await uploadRes.json().catch(() => ({ error: 'Upload failed' }));
          throw new Error(errorData.error || 'Upload failed');
        }
        
        const uploadData = await uploadRes.json();
        data.file_url = uploadData.url;
        data.file_name = uploadData.fileName;
      } catch (error: any) {
        if (alpineData) {
          alpineData.error = error.message || 'File upload failed. Please try again.';
          alpineData.uploading = false;
        } else {
          alert(error.message || 'File upload failed. Please try again.');
        }
        return;
      }
    }
    
    // Submit resource
    try {
      const res = await fetch('/api/resources', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      
      if (!res.ok) {
        const error = await res.json().catch(() => ({ error: 'Submission failed' }));
        throw new Error(error.error || 'Submission failed');
      }
      
      const responseData = await res.json();
      
      if (alpineData) {
        alpineData.success = true;
        alpineData.uploading = false;
        alpineData.successMessage = responseData.message || 'Resource submitted successfully! It will be added to the site within 24 hours.';
        form.reset();
        // Reset Alpine state
        alpineData.hasFile = false;
        alpineData.hasExternalLink = false;
        
        // Scroll to success message
        setTimeout(() => {
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        alert(responseData.message || 'Resource submitted successfully! It will be added to the site within 24 hours.');
        form.reset();
      }
    } catch (error: any) {
      if (alpineData) {
        alpineData.error = error.message || 'An error occurred. Please try again.';
        alpineData.uploading = false;
      } else {
        alert(error.message || 'An error occurred. Please try again.');
      }
    }
  });
</script>
