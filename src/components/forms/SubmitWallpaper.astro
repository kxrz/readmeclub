---
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/components/Button.astro";
import { useTranslations, getLangFromUrl } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<form
  id="submit-wallpaper-form"
  class="relative w-full max-w-2xl mx-auto space-y-8 bg-white ring-1 ring-base-200 rounded-2xl p-8 lg:p-12"
  x-data="{ 
    uploading: false, 
    fileUrl: null,
    filePreview: null,
    error: null,
    success: false
  }"
  @submit.prevent="uploading = true; error = null; success = false"
>
  <!-- Basic Information -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.basic_info')}
      </Text>
    </div>

    <div>
      <label for="title" class="sr-only">{t('form.title')}</label>
      <input
        type="text"
        id="title"
        name="title"
        maxlength="60"
        placeholder={t('wallpapers.form.title_placeholder')}
        class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
      />
    </div>

    <div>
      <label for="category" class="sr-only">{t('wallpapers.form.category')}</label>
      <select
        id="category"
        name="category"
        class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
      >
        <option value="">{t('common.optional')} - {t('wallpapers.form.category')}</option>
        <option value="minimalist">{t('wallpapers.category.minimalist')}</option>
        <option value="dark">{t('wallpapers.category.dark')}</option>
        <option value="light">{t('wallpapers.category.light')}</option>
        <option value="pop_culture">{t('wallpapers.category.pop_culture')}</option>
        <option value="custom">{t('wallpapers.category.custom')}</option>
        <option value="other">{t('wallpapers.category.other')}</option>
      </select>
    </div>
  </div>

  <!-- Wallpaper Image -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('wallpapers.form.image')}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-4">
        {t('wallpapers.form.image_help')}
      </Text>
    </div>

    <div>
      <label for="file" class="sr-only">{t('wallpapers.form.image')}</label>
      <input
        type="file"
        id="file"
        name="file"
        accept="image/png,image/jpeg,image/jpg,image/bmp"
        required
        @change="
          const file = $event.target.files[0];
          if (file) {
            filePreview = URL.createObjectURL(file);
            fileUrl = null;
          }
        "
        class="block w-full text-sm text-base-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-accent-500 file:text-white hover:file:bg-accent-600 file:cursor-pointer"
      />
    </div>

    <!-- Preview -->
    <div x-show="filePreview" x-transition class="mt-4">
      <img 
        :src="filePreview" 
        alt="Preview" 
        class="max-w-full max-h-96 rounded-lg border-2 border-base-200 object-contain"
      />
    </div>
  </div>

  <!-- Contributor Information -->
  <div class="space-y-6">
    <div>
      <Text tag="h2" variant="textLG" class="font-semibold text-base-900 mb-4">
        {t('form.contributor_info')}
      </Text>
      <Text tag="p" variant="textSM" class="text-base-600 mb-4">
        {t('form.contributor_info_help')}
      </Text>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="author_name" class="sr-only">{t('wallpapers.form.author_name')}</label>
        <input
          type="text"
          id="author_name"
          name="author_name"
          maxlength="50"
          placeholder={t('wallpapers.form.author_name_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>

      <div>
        <label for="reddit_username" class="sr-only">{t('wallpapers.form.reddit_username')}</label>
        <input
          type="text"
          id="reddit_username"
          name="reddit_username"
          maxlength="30"
          placeholder={t('wallpapers.form.reddit_username_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>

      <div>
        <label for="instagram_username" class="sr-only">{t('wallpapers.form.instagram_username')}</label>
        <input
          type="text"
          id="instagram_username"
          name="instagram_username"
          maxlength="30"
          placeholder={t('wallpapers.form.instagram_username_placeholder')}
          class="block w-full h-10 px-4 py-2 text-sm text-base-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-base-500 focus:ring-offset-2 focus:ring-2"
        />
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div x-show="error" x-transition class="p-4 bg-red-50 border border-red-200 rounded-lg">
    <Text tag="p" variant="textSM" class="text-red-700">
      <span x-text="error"></span>
    </Text>
  </div>

  <!-- Success Message -->
  <div x-show="success" x-transition class="p-4 bg-green-50 border border-green-200 rounded-lg">
    <Text tag="p" variant="textSM" class="text-green-700">
      {t('wallpapers.form.success_message')}
    </Text>
  </div>

  <!-- Copyright Notice -->
  <div class="p-4 bg-base-50 border-l-4 border-base-300 rounded-r-lg">
    <Text tag="p" variant="textXS" class="text-base-600">
      {t('wallpapers.form.copyright_notice')}
    </Text>
  </div>

  <!-- Submit Button -->
  <div class="pt-4">
    <Button
      type="submit"
      variant="accent"
      size="lg"
      class="w-full justify-center"
      x-bind:disabled="uploading"
    >
      <span x-show="!uploading">{t('form.submit')}</span>
      <span x-show="uploading">{t('form.uploading')}</span>
    </Button>
  </div>
</form>

<script>
  document.getElementById('submit-wallpaper-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const alpineData = (window as any).Alpine?.$data(form);
    
    if (alpineData) {
      alpineData.uploading = true;
      alpineData.error = null;
      alpineData.success = false;
    }

    const formData = new FormData(form);
    const fileInput = form.querySelector('#file') as HTMLInputElement;
    const file = fileInput?.files?.[0];
    
    if (!file) {
      if (alpineData) {
        alpineData.error = 'Please select an image file.';
        alpineData.uploading = false;
      } else {
        alert('Please select an image file.');
      }
      return;
    }
    
    // Validate file format
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.') + 1);
    const allowedExtensions = ['png', 'jpg', 'jpeg', 'bmp'];
    
    const isValidType = file.type && allowedTypes.includes(file.type);
    const isValidExtension = allowedExtensions.includes(fileExtension);
    
    if (!isValidType && !isValidExtension) {
      if (alpineData) {
        alpineData.error = `File type not allowed. Allowed formats: ${allowedExtensions.join(', ')}`;
        alpineData.uploading = false;
      } else {
        alert(`File type not allowed. Allowed formats: ${allowedExtensions.join(', ')}`);
      }
      return;
    }
    
    // Validate file size (max 10MB)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      if (alpineData) {
        alpineData.error = 'File too large (max 10MB)';
        alpineData.uploading = false;
      } else {
        alert('File too large (max 10MB)');
      }
      return;
    }
    
    // Upload file
    const uploadFormData = new FormData();
    uploadFormData.append('file', file);
    
    let uploadData;
    try {
      const uploadRes = await fetch('/api/wallpapers/upload', {
        method: 'POST',
        body: uploadFormData,
      });
      
      if (!uploadRes.ok) {
        const errorData = await uploadRes.json().catch(() => ({ error: 'Upload failed' }));
        throw new Error(errorData.error || 'Upload failed');
      }
      
      uploadData = await uploadRes.json();
    } catch (error: any) {
      if (alpineData) {
        alpineData.error = error.message || 'File upload failed. Please try again.';
        alpineData.uploading = false;
      } else {
        alert(error.message || 'File upload failed. Please try again.');
      }
      return;
    }
    
    // Prepare wallpaper data
    const wallpaperData: Record<string, any> = {
      file_url: uploadData.url,
      file_name: uploadData.fileName,
      file_size: uploadData.fileSize,
      width: uploadData.width,
      height: uploadData.height,
    };
    
    // Add optional fields
    const title = formData.get('title')?.toString().trim();
    if (title) wallpaperData.title = title;
    
    const category = formData.get('category')?.toString().trim();
    if (category) wallpaperData.category = category;
    
    const authorName = formData.get('author_name')?.toString().trim();
    if (authorName) wallpaperData.author_name = authorName;
    
    const redditUsername = formData.get('reddit_username')?.toString().trim();
    if (redditUsername) wallpaperData.reddit_username = redditUsername;
    
    const instagramUsername = formData.get('instagram_username')?.toString().trim();
    if (instagramUsername) wallpaperData.instagram_username = instagramUsername;
    
    // Submit wallpaper
    try {
      const res = await fetch('/api/wallpapers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(wallpaperData),
      });
      
      if (!res.ok) {
        const error = await res.json().catch(() => ({ error: 'Submission failed' }));
        throw new Error(error.error || 'Submission failed');
      }
      
      if (alpineData) {
        alpineData.success = true;
        alpineData.uploading = false;
        form.reset();
        alpineData.filePreview = null;
        
        // Scroll to success message
        setTimeout(() => {
          form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      } else {
        alert('Wallpaper submitted successfully!');
        form.reset();
      }
    } catch (error: any) {
      if (alpineData) {
        alpineData.error = error.message || 'An error occurred. Please try again.';
        alpineData.uploading = false;
      } else {
        alert(error.message || 'An error occurred. Please try again.');
      }
    }
  });
</script>

