---
import { AstroSeo } from "@astrolib/seo";
import { normalizeSiteUrl, buildUrl } from '@/lib/utils/url';

interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  ogType?: 'website' | 'article';
  lang?: string;
  noindex?: boolean;
}

const {
  title,
  description,
  canonical,
  ogImage,
  ogType = 'website',
  lang = 'en',
  noindex = false,
} = Astro.props;

// Normaliser siteUrl pour Ã©viter les doubles slashes
const siteUrl = normalizeSiteUrl(Astro.site);
const currentUrl = canonical || new URL(Astro.url.pathname, siteUrl).toString();
const defaultOgImage = ogImage || buildUrl(`/api/og-image.png?title=${encodeURIComponent(title)}`, siteUrl);

const localeMap: Record<string, string> = {
  en: 'en_US',
  fr: 'fr_FR',
  es: 'es_ES',
  ru: 'ru_RU',
  cn: 'zh_CN',
};

const ogLocale = localeMap[lang] || 'en_US';
---

<AstroSeo
  title={title}
  description={description}
  canonical={currentUrl}
  openGraph={{
    url: currentUrl,
    title: title,
    description: description,
    images: [
      {
        url: defaultOgImage,
        width: 1200,
        height: 630,
        alt: title,
        type: 'image/png',
      },
    ],
    site_name: 'Readme.club',
    type: ogType,
    locale: ogLocale,
  }}
  twitter={{
    cardType: 'summary_large_image',
  }}
/>

{noindex && (
  <meta name="robots" content="noindex, nofollow" />
)}

{!noindex && (
  <>
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
  </>
)}

<!-- OpenGraph image dimensions (explicit for async processing) -->
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:type" content="image/png" />
