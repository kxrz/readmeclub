---
import { AstroSeo } from "@astrolib/seo";
import { normalizeSiteUrl, buildUrl } from '@/lib/utils/url';

interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  ogType?: 'website' | 'article';
  lang?: string;
  noindex?: boolean;
  jsonLd?: object | object[];
  alternateLanguages?: { lang: string; href: string }[];
}

const {
  title,
  description,
  canonical,
  ogImage,
  ogType = 'website',
  lang = 'en',
  noindex = false,
  jsonLd,
  alternateLanguages,
} = Astro.props;

// Normaliser siteUrl pour Ã©viter les doubles slashes
const siteUrl = normalizeSiteUrl(Astro.site);
const currentUrl = canonical || new URL(Astro.url.pathname, siteUrl).toString();
const defaultOgImage = ogImage || buildUrl(`/api/og-image.png?title=${encodeURIComponent(title)}`, siteUrl);

const localeMap: Record<string, string> = {
  en: 'en_US',
  fr: 'fr_FR',
  es: 'es_ES',
  ru: 'ru_RU',
  cn: 'zh_CN',
};

const ogLocale = localeMap[lang] || 'en_US';

// Schema.org de base pour le site
const baseSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "readme.club",
  "url": siteUrl,
  "description": "Community hub for Xteink X4 e-reader - wallpapers, fonts, firmware, guides and resources",
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${siteUrl}/resources?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "readme.club",
  "url": siteUrl,
  "logo": `${siteUrl}/favicon.svg`,
  "sameAs": [
    "https://www.reddit.com/r/xteinkereader/"
  ]
};

// Combiner les schemas
const allSchemas = jsonLd 
  ? [baseSchema, organizationSchema, ...(Array.isArray(jsonLd) ? jsonLd : [jsonLd])]
  : [baseSchema, organizationSchema];
---

<AstroSeo
  title={title}
  description={description}
  canonical={currentUrl}
  openGraph={{
    url: currentUrl,
    title: title,
    description: description,
    images: [
      {
        url: defaultOgImage,
        width: 1200,
        height: 630,
        alt: title,
        type: 'image/png',
      },
    ],
    site_name: 'readme.club',
    type: ogType,
    locale: ogLocale,
  }}
  twitter={{
    cardType: 'summary_large_image',
  }}
/>

{noindex && (
  <meta name="robots" content="noindex, nofollow" />
)}

{!noindex && (
  <>
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
  </>
)}

<!-- OpenGraph image dimensions (explicit for async processing) -->
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:type" content="image/png" />

<!-- Hreflang for multilingual SEO -->
{alternateLanguages && alternateLanguages.map((alt) => (
  <link rel="alternate" hreflang={alt.lang === 'cn' ? 'zh' : alt.lang} href={alt.href} />
))}
{alternateLanguages && (
  <link rel="alternate" hreflang="x-default" href={currentUrl.replace(/\/(fr|es|ru|cn)\//, '/')} />
)}

<!-- JSON-LD Schema.org -->
<script type="application/ld+json" set:html={JSON.stringify(allSchemas)} />
