---
import Text from "@/components/fundations/elements/Text.astro";
import { useTranslations, getLangFromUrl, getLangPrefix } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const langPrefix = getLangPrefix(lang);
const t = useTranslations(lang);
---

<div
  x-data="{
    show: false,
    submitting: false,
    success: false,
    error: null,
    init() {
      // VÃ©rifier si on doit afficher le popup
      const dismissed = localStorage.getItem('newsletter_popup_dismissed');
      const subscribed = localStorage.getItem('newsletter_popup_subscribed');
      
      // Ne pas afficher si dÃ©jÃ  inscrit
      if (subscribed === 'true') {
        return;
      }
      
      // Fonction pour vÃ©rifier si on peut afficher le popup
      const canShow = () => {
        // Ne pas afficher si fermÃ© rÃ©cemment (dans les 14 derniers jours - 2 semaines)
        if (dismissed) {
          const dismissedDate = parseInt(dismissed);
          const daysSinceDismissed = (Date.now() - dismissedDate) / (1000 * 60 * 60 * 24);
          if (daysSinceDismissed < 14) {
            return false;
          }
        }
        return true;
      };
      
      // Fonction pour afficher le popup
      const showPopup = () => {
        if (canShow() && !this.show) {
          this.show = true;
        }
      };
      
      // Ã‰couter les Ã©vÃ©nements de tÃ©lÃ©chargement (wallpaper, resource, guide)
      window.addEventListener('wallpaper-downloaded', () => {
        // Afficher aprÃ¨s 3 secondes pour laisser le temps au tÃ©lÃ©chargement de dÃ©marrer
        setTimeout(() => {
          showPopup();
        }, 3000);
      });
      
      window.addEventListener('resource-downloaded', () => {
        setTimeout(() => {
          showPopup();
        }, 3000);
      });
      
      window.addEventListener('guide-downloaded', () => {
        setTimeout(() => {
          showPopup();
        }, 3000);
      });
      
      // Ne pas afficher automatiquement si fermÃ© rÃ©cemment
      if (!canShow()) {
        return;
      }
      
      // Afficher aprÃ¨s 30 secondes ou aprÃ¨s scroll de 50%
      let shown = false;
      
      // DÃ©lai de 30 secondes
      setTimeout(() => {
        if (!shown && canShow()) {
          this.show = true;
          shown = true;
        }
      }, 30000);
      
      // AprÃ¨s scroll de 50%
      const handleScroll = () => {
        const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
        if (scrollPercent >= 50 && !shown && canShow()) {
          this.show = true;
          shown = true;
          window.removeEventListener('scroll', handleScroll);
        }
      };
      
      window.addEventListener('scroll', handleScroll);
    },
    close() {
      this.show = false;
      localStorage.setItem('newsletter_popup_dismissed', Date.now().toString());
    },
    subscribe: async function(event) {
      event.preventDefault();
      const form = event.target;
      const emailInput = form.querySelector('input[type=\'email\']');
      const email = emailInput?.value.trim();
      
      if (!email) {
        this.error = 'Please enter your email address';
        return;
      }
      
      this.submitting = true;
      this.error = null;
      
      try {
        const response = await fetch('/api/newsletter/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          this.success = true;
          localStorage.setItem('newsletter_popup_subscribed', 'true');
          if (emailInput) {
            emailInput.value = '';
          }
          
          // Fermer automatiquement aprÃ¨s 3 secondes
          setTimeout(() => {
            this.close();
          }, 3000);
        } else {
          this.error = data.error || 'Failed to subscribe';
        }
      } catch (error) {
        console.error('Subscription error:', error);
        this.error = 'An error occurred. Please try again.';
      } finally {
        this.submitting = false;
      }
    }
  }"
  x-show="show"
  x-transition:enter="transition ease-out duration-300"
  x-transition:enter-start="transform translate-x-full opacity-0"
  x-transition:enter-end="transform translate-x-0 opacity-100"
  x-transition:leave="transition ease-in duration-200"
  x-transition:leave-start="transform translate-x-0 opacity-100"
  x-transition:leave-end="transform translate-x-full opacity-0"
  style="display: none;"
  class="fixed bottom-4 right-4 z-50 max-w-sm"
>
  <div class="bg-base-900 dark:bg-base-800 text-base-50 rounded-lg shadow-xl border border-base-200 dark:border-base-700 p-4 lg:p-5 flex flex-col gap-3">
    <div class="flex items-start justify-between gap-3">
      <div class="flex items-start gap-2 flex-1">
        <span class="text-xl shrink-0" aria-hidden="true">ðŸ“§</span>
        <div class="flex-1 min-w-0">
          <Text tag="p" variant="textSM" class="font-semibold text-base-50 mb-1">
            Stay updated
          </Text>
          <Text tag="p" variant="textXS" class="text-base-300 dark:text-base-400 mb-3">
            Get notified about new resources, wallpapers, and community updates. No spam, just occasional updates.
          </Text>
          
          <div x-show="!success">
            <form @submit.prevent="subscribe" class="flex flex-col gap-2">
              <input
                type="email"
                placeholder="your.email@example.com"
                required
                class="w-full px-3 py-2 text-sm text-base-900 bg-base-50 rounded-lg border border-base-200 dark:border-base-600 focus:ring-2 focus:ring-accent-500 focus:border-accent-500 outline-none transition-colors"
              />
              <div class="flex gap-2">
                <button
                  type="submit"
                  :disabled="submitting"
                  class="flex-1 px-4 py-2 text-sm bg-accent-500 text-base-50 rounded-lg hover:bg-accent-600 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <span x-show="!submitting">Subscribe</span>
                  <span x-show="submitting">Subscribing...</span>
                </button>
                <button
                  type="button"
                  @click="close()"
                  class="px-3 py-2 text-sm text-base-400 hover:text-base-300 transition-colors"
                >
                  Maybe later
                </button>
              </div>
              <div x-show="error" x-cloak class="text-xs text-red-300 mt-1">
                <span x-text="error"></span>
              </div>
            </form>
          </div>
          
          <div x-show="success" x-cloak class="text-sm text-green-300">
            âœ“ Successfully subscribed! Check your inbox for a welcome email.
          </div>
        </div>
      </div>
      <button
        @click="close()"
        class="shrink-0 text-base-50 hover:text-base-300 focus:outline-none transition-colors p-1"
        aria-label="Close newsletter popup"
      >
        <svg
          class="size-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>
